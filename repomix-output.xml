This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
admin/add_book.php
admin/add_member.php
admin/admin_dashboard.php
admin/admin_login.php
admin/ajax_add_category.php
admin/browse_categories.php
admin/delete_book.php
admin/delete_member.php
admin/edit_book.php
admin/edit_member.php
admin/fines.php
admin/fix_code.php
admin/issue_book.php
admin/manage_book.php
admin/manage_categories.php
admin/manage_members.php
admin/manage_requests.php
admin/profile.php
admin/reports.php
admin/return_book.php
assets/css/admin.css
assets/css/auth.css
assets/css/login.css
assets/css/register.css
assets/css/style.css
assets/js/auth.js
assets/js/validation.js
assets/uploads/699b00a143172.jpg
assets/uploads/699b00c8923ef.jpg
assets/uploads/699b010059f68.jpg
auth/forget_password.php
auth/login.php
auth/logout.php
auth/register.php
auth/reset_password.php
config/db.php
config/functions.php
config/reset_dmin.php
config/validation.php
database.sql
includes/admin_sidebar.php
includes/footer.php
includes/header.php
index.php
member/books.php
member/browse_categories.php
member/dashboard.php
member/issued_books.php
member/member_sidebar.php
member/my_requests.php
member/profile.php
member/request_book.php
member/view_book.php
member/viewBook.php
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="admin/delete_book.php">
<?php
require_once '../config/db.php';
requireAdmin();

if(!isset($_GET['id'])) {
    header("Location: manage_book.php");
    exit;
}

$id = $_GET['id'];

// Check if book exists and has no issued copies
$sql = "SELECT available_copies, total_copies FROM books WHERE id = ?";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "i", $id);
mysqli_stmt_execute($stmt);
mysqli_stmt_bind_result($stmt, $available_copies, $total_copies);
mysqli_stmt_fetch($stmt);
mysqli_stmt_close($stmt);

if($available_copies != $total_copies) {
    header("Location: manage_book.php?error=Cannot delete book that has been issued to members");
    exit;
}

// Delete book
$delete_sql = "DELETE FROM books WHERE id = ?";
$delete_stmt = mysqli_prepare($conn, $delete_sql);
mysqli_stmt_bind_param($delete_stmt, "i", $id);

if(mysqli_stmt_execute($delete_stmt)) {
    header("Location: manage_book.php?msg=Book deleted successfully");
} else {
    header("Location: manage_book.php?error=Error deleting book");
}

mysqli_stmt_close($delete_stmt);
?>
</file>

<file path="admin/delete_member.php">
<?php
require_once '../config/db.php';
requireAdmin();

if(!isset($_GET['id'])) {
    header("Location: manage_members.php");
    exit;
}

$id = $_GET['id'];

// Check if member has issued books
$check_sql = "SELECT COUNT(*) as count FROM issued_books WHERE user_id = ? AND status = 'issued'";
$check_stmt = mysqli_prepare($conn, $check_sql);
mysqli_stmt_bind_param($check_stmt, "i", $id);
mysqli_stmt_execute($check_stmt);
mysqli_stmt_bind_result($check_stmt, $issued_count);
mysqli_stmt_fetch($check_stmt);
mysqli_stmt_close($check_stmt);

if($issued_count > 0) {
    header("Location: manage_members.php?error=Cannot delete student who has issued books. Return all books first.");
    exit;
}

// Delete member
$delete_sql = "DELETE FROM users WHERE id = ? AND role = 'member'";
$delete_stmt = mysqli_prepare($conn, $delete_sql);
mysqli_stmt_bind_param($delete_stmt, "i", $id);

if(mysqli_stmt_execute($delete_stmt)) {
    header("Location: manage_members.php?msg=Student deleted successfully");
} else {
    header("Location: manage_members.php?error=Error deleting student");
}

mysqli_stmt_close($delete_stmt);
?>
</file>

<file path="admin/edit_member.php">
<?php
require_once '../config/db.php';
requireAdmin();

if(!isset($_GET['id'])) {
    header("Location: manage_members.php");
    exit;
}

$id = $_GET['id'];
$error = '';
$success = '';

// Fetch member details
$sql = "SELECT * FROM users WHERE id = ? AND role = 'member'";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "i", $id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$member = mysqli_fetch_assoc($result);

if(!$member) {
    header("Location: manage_members.php?error=Student not found");
    exit;
}

if($_SERVER["REQUEST_METHOD"] == "POST") {
    $full_name = Validation::sanitize($_POST['full_name']);
    $email = Validation::sanitize($_POST['email']);
    $phone = Validation::sanitize($_POST['phone']);
    $status = Validation::sanitize($_POST['status']);
    
    // Validate data
    $name_validation = Validation::validate('Full Name', $full_name, 'name');
    $email_validation = Validation::validate('Email', $email, 'email');
    
    if(isset($name_validation['error'])) {
        $error = $name_validation['error'];
    } elseif(isset($email_validation['error'])) {
        $error = $email_validation['error'];
    } else {
        // Check if email already exists (excluding current member)
        $check_sql = "SELECT id FROM users WHERE email = ? AND id != ?";
        $check_stmt = mysqli_prepare($conn, $check_sql);
        mysqli_stmt_bind_param($check_stmt, "si", $email, $id);
        mysqli_stmt_execute($check_stmt);
        mysqli_stmt_store_result($check_stmt);
        
        if(mysqli_stmt_num_rows($check_stmt) > 0) {
            $error = "Email already exists";
        } else {
            $update_sql = "UPDATE users SET full_name = ?, email = ?, phone = ?, status = ? WHERE id = ?";
            $update_stmt = mysqli_prepare($conn, $update_sql);
            mysqli_stmt_bind_param($update_stmt, "ssssi", $full_name, $email, $phone, $status, $id);
            
            if(mysqli_stmt_execute($update_stmt)) {
                $success = "Student updated successfully!";
            } else {
                $error = "Error updating student: " . mysqli_error($conn);
            }
            mysqli_stmt_close($update_stmt);
        }
        mysqli_stmt_close($check_stmt);
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Student - Library System</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Edit Student</h1>
                <a href="manage_members.php" class="btn">‚Üê Back to Students</a>
            </div>
            
            <div class="card">
                <?php if($error): ?>
                    <div class="alert alert-error"><?php echo $error; ?></div>
                <?php endif; ?>
                
                <?php if($success): ?>
                    <div class="alert alert-success"><?php echo $success; ?></div>
                <?php endif; ?>
                
                <form method="POST">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" class="form-control" 
                               value="<?php echo htmlspecialchars($member['username']); ?>" readonly>
                        <small class="help-text">Username cannot be changed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="full_name">Full Name *</label>
                        <input type="text" id="full_name" name="full_name" class="form-control" 
                               value="<?php echo htmlspecialchars($member['full_name']); ?>" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" class="form-control" 
                                   value="<?php echo htmlspecialchars($member['email']); ?>" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-control" 
                                   value="<?php echo htmlspecialchars($member['phone'] ?? ''); ?>">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">Account Status</label>
                            <select id="status" name="status" class="form-control">
                                <option value="active" <?php echo ($member['status'] == 'active') ? 'selected' : ''; ?>>Active</option>
                                <option value="inactive" <?php echo ($member['status'] == 'inactive') ? 'selected' : ''; ?>>Inactive</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Member Since</label>
                            <input type="text" class="form-control" 
                                   value="<?php echo date('F j, Y', strtotime($member['created_at'])); ?>" readonly>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Update Student</button>
                    <a href="manage_members.php" class="btn">Cancel</a>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
</file>

<file path="assets/css/auth.css">
/* Auth Pages */
.auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
}

.auth-box {
    background: white;
    border-radius: 15px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    width: 100%;
    max-width: 450px;
    padding: 40px;
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.auth-header {
    text-align: center;
    margin-bottom: 30px;
}

.auth-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 28px;
}

.auth-header p {
    color: #7f8c8d;
    font-size: 16px;
}

.auth-form .form-group {
    margin-bottom: 25px;
}

.auth-form .btn {
    width: 100%;
    padding: 14px;
    font-size: 17px;
    margin-top: 10px;
}

.auth-footer {
    text-align: center;
    margin-top: 25px;
    color: #7f8c8d;
}

.auth-footer a {
    color: #3498db;
    text-decoration: none;
    font-weight: 500;
}

.auth-footer a:hover {
    text-decoration: underline;
}

/* Role Selection */
.role-selector {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
}

.role-option {
    flex: 1;
    text-align: center;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.role-option:hover {
    border-color: #3498db;
}

.role-option.selected {
    border-color: #3498db;
    background: #f0f8ff;
}

.role-option input {
    display: none;
}

.role-option i {
    font-size: 24px;
    color: #7f8c8d;
    margin-bottom: 10px;
}

.role-option.selected i {
    color: #3498db;
}

/* Validation Styles */
.is-invalid {
    border-color: #e74c3c !important;
}

.is-valid {
    border-color: #2ecc71 !important;
}

.invalid-feedback {
    color: #e74c3c;
    font-size: 14px;
    margin-top: 5px;
    display: none;
}

.invalid-feedback.show {
    display: block;
}
</file>

<file path="assets/css/login.css">
/* Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, Helvetica, sans-serif;
}

/* Body */
body {
    background-color: #f2f4f7;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Container */
.container {
    background: #ffffff;
    width: 400px;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Heading */
h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
}

/* Input fields */
input {
    width: 100%;
    padding: 10px;
    margin: 7px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

/* Button */
button {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
}

button:hover {
    background: #084298;
}

/* Error / Success messages */
.error {
    color: #dc3545;
    text-align: center;
    margin-bottom: 10px;
}

.success {
    color: #198754;
    text-align: center;
    margin-bottom: 10px;
}

/* Paragraph & Links */
p {
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
}

a {
    color: #0d6efd;
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}
</file>

<file path="assets/css/register.css">
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, Helvetica, sans-serif;
}

body {
    background-color: #f2f4f7;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.container {
    background: #ffffff;
    width: 420px;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
}

input,
textarea {
    width: 100%;
    padding: 10px;
    margin: 7px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

textarea {
    resize: none;
    height: 80px;
}

button {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
}

button:hover {
    background: #084298;
}

p {
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
}

a {
    color: #0d6efd;
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

.error {
    color: #dc3545;
    text-align: center;
    margin-bottom: 10px;
}

.success {
    color: #198754;
    text-align: center;
    margin-bottom: 10px;
}
</file>

<file path="assets/js/auth.js">
// Auth Form Validation
function validateLoginForm() {
    const username = document.getElementById('username');
    const password = document.getElementById('password');
    
    // Clear previous errors
    document.querySelectorAll('.invalid-feedback').forEach(el => {
        el.classList.remove('show');
    });
    document.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });
    
    let isValid = true;
    
    // Validate username
    if (!username.value.trim()) {
        showError(username, "Username is required");
        isValid = false;
    } else if (!/^[a-zA-Z0-9_]{3,20}$/.test(username.value)) {
        showError(username, "Username: 3-20 chars, letters/numbers/underscore only");
        isValid = false;
    }
    
    // Validate password
    if (!password.value) {
        showError(password, "Password is required");
        isValid = false;
    } else if (password.value.length < 3) {
        showError(password, "Password must be at least 3 characters");
        isValid = false;
    }
    
    return isValid;
}

function validateRegisterForm() {
    const rules = {
        username: /^[a-zA-Z0-9_]{3,20}$/,
        password: /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$/,
        email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
        full_name: /^[a-zA-Z\s]{2,50}$/,
        phone: /^[6-9]\d{9}$/
    };
    
    const messages = {
        username: "Username: 3-20 chars, letters/numbers/underscore only",
        password: "Password: min 6 chars with at least 1 letter and 1 number",
        email: "Enter a valid email address",
        full_name: "Full name: 2-50 letters and spaces only",
        phone: "Enter a valid 10-digit Indian mobile number"
    };
    
    let isValid = true;
    
    for (const [fieldName, pattern] of Object.entries(rules)) {
        const field = document.getElementById(fieldName);
        if (field) {
            const value = field.value.trim();
            if (!value) {
                showError(field, `${fieldName.replace('_', ' ')} is required`);
                isValid = false;
            } else if (!pattern.test(value)) {
                showError(field, messages[fieldName]);
                isValid = false;
            } else {
                clearError(field);
            }
        }
    }
    
    // Check password confirmation
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirm_password');
    if (password && confirmPassword && password.value !== confirmPassword.value) {
        showError(confirmPassword, "Passwords do not match");
        isValid = false;
    }
    
    return isValid;
}

// Role Selection
document.addEventListener('DOMContentLoaded', function() {
    const roleOptions = document.querySelectorAll('.role-option');
    roleOptions.forEach(option => {
        option.addEventListener('click', function() {
            roleOptions.forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            const input = this.querySelector('input');
            if (input) input.checked = true;
        });
    });
});

// Helper Functions
function showError(element, message) {
    element.classList.add('is-invalid');
    element.classList.remove('is-valid');
    
    let feedback = element.nextElementSibling;
    if (!feedback || !feedback.classList.contains('invalid-feedback')) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        element.parentNode.appendChild(feedback);
    }
    
    feedback.textContent = message;
    feedback.classList.add('show');
}

function clearError(element) {
    element.classList.remove('is-invalid');
    element.classList.add('is-valid');
    
    const feedback = element.nextElementSibling;
    if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.classList.remove('show');
    }
}
</file>

<file path="assets/js/validation.js">
// Regex Patterns
const patterns = {
    username: /^[a-zA-Z0-9_]{3,20}$/,
    password: /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$/,
    email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
    name: /^[a-zA-Z\s]{2,50}$/,
    isbn: /^(?:\d{3}-)?\d{1,5}-\d{1,7}-\d{1,7}-\d{1,7}$|^\d{10}$|^\d{13}$/,
    phone: /^[6-9]\d{9}$/,
    number: /^\d+$/,
    date: /^\d{4}-\d{2}-\d{2}$/
};

// Validation Functions
class Validator {
    static validateField(field, pattern, message) {
        const value = field.value.trim();
        const feedback = field.nextElementSibling;
        
        if (!value) {
            this.showError(field, feedback, "This field is required");
            return false;
        }
        
        if (!pattern.test(value)) {
            this.showError(field, feedback, message);
            return false;
        }
        
        this.showSuccess(field, feedback);
        return true;
    }
    
    static showError(field, feedback, message) {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        feedback.textContent = message;
        feedback.classList.add('show');
    }
    
    static showSuccess(field, feedback) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        feedback.classList.remove('show');
    }
    
    static validateEmail(email) {
        return patterns.email.test(email);
    }
    
    static validatePassword(password) {
        return patterns.password.test(password);
    }
    
    static validatePhone(phone) {
        return patterns.phone.test(phone);
    }
    
    static validateForm(formData, rules) {
        let isValid = true;
        
        for (const [fieldName, rule] of Object.entries(rules)) {
            const field = formData[fieldName];
            if (!this.validateField(field, rule.pattern, rule.message)) {
                isValid = false;
            }
        }
        
        return isValid;
    }
}

// Specific Validations
const authRules = {
    username: {
        pattern: patterns.username,
        message: "Username: 3-20 chars, letters, numbers, underscore only"
    },
    password: {
        pattern: patterns.password,
        message: "Password: min 6 chars with at least 1 letter and 1 number"
    },
    email: {
        pattern: patterns.email,
        message: "Enter a valid email address"
    },
    full_name: {
        pattern: patterns.name,
        message: "Name: 2-50 letters and spaces only"
    }
};

const bookRules = {
    title: {
        pattern: patterns.name,
        message: "Title: 2-50 characters required"
    },
    author: {
        pattern: patterns.name,
        message: "Author name: 2-50 characters required"
    },
    isbn: {
        pattern: patterns.isbn,
        message: "Enter valid ISBN (10 or 13 digits, with optional hyphens)"
    },
    copies: {
        pattern: patterns.number,
        message: "Enter valid number of copies"
    }
};

// Real-time Validation
document.addEventListener('DOMContentLoaded', function() {
    // Real-time username validation
    const usernameInput = document.getElementById('username');
    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            Validator.validateField(this, patterns.username, 
                "Username: 3-20 chars, letters, numbers, underscore only");
        });
    }
    
    // Real-time email validation
    const emailInput = document.getElementById('email');
    if (emailInput) {
        emailInput.addEventListener('input', function() {
            Validator.validateField(this, patterns.email, 
                "Enter a valid email address");
        });
    }
    
    // Real-time password validation
    const passwordInput = document.getElementById('password');
    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            Validator.validateField(this, patterns.password, 
                "Password: min 6 chars with at least 1 letter and 1 number");
        });
    }
    
    // Password confirmation
    const confirmPasswordInput = document.getElementById('confirm_password');
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', function() {
            const password = document.getElementById('password');
            if (password && password.value !== this.value) {
                Validator.showError(this, this.nextElementSibling, 
                    "Passwords do not match");
            } else {
                Validator.showSuccess(this, this.nextElementSibling);
            }
        });
    }
});
</file>

<file path="config/validation.php">
<?php
// Validation Class with Regex
class Validation {
    
    // Regex Patterns
    const PATTERNS = [
        'username' => '/^[a-zA-Z0-9_]{3,20}$/',
        'password' => '/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$/',
        'email' => '/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/',
        'name' => '/^[a-zA-Z\s]{2,50}$/',
        'isbn' => '/^(?:\d{3}-)?\d{1,5}-\d{1,7}-\d{1,7}-\d{1,7}$|^\d{10}$|^\d{13}$/',
        'phone' => '/^[6-9]\d{9}$/',
        'number' => '/^\d+$/',
        'date' => '/^\d{4}-\d{2}-\d{2}$/'
    ];
    
    // Validate field with regex
    public static function validate($field, $value, $type) {
        if (empty(trim($value))) {
            return ["error" => "$field is required"];
        }
        
        if (!isset(self::PATTERNS[$type])) {
            return ["error" => "Invalid validation type"];
        }
        
        if (!preg_match(self::PATTERNS[$type], trim($value))) {
            $messages = [
                'username' => "Username must be 3-20 chars (letters, numbers, underscore only)",
                'password' => "Password must be min 6 chars with at least 1 letter and 1 number",
                'email' => "Please enter a valid email address",
                'name' => "Name must be 2-50 letters and spaces only",
                'isbn' => "Please enter a valid ISBN (10 or 13 digits)",
                'phone' => "Please enter a valid 10-digit mobile number",
                'number' => "Please enter a valid number",
                'date' => "Please enter a valid date (YYYY-MM-DD)"
            ];
            return ["error" => $messages[$type] ?? "Invalid format"];
        }
        
        return ["success" => true];
    }
    
    // Sanitize input
    public static function sanitize($input) {
        $input = trim($input);
        $input = stripslashes($input);
        $input = htmlspecialchars($input);
        return $input;
    }
    
    // Validate book data
    public static function validateBook($data) {
        $errors = [];
        
        // Validate title
        $titleValidation = self::validate('Title', $data['title'], 'name');
        if (isset($titleValidation['error'])) {
            $errors['title'] = $titleValidation['error'];
        }
        
        // Validate author
        $authorValidation = self::validate('Author', $data['author'], 'name');
        if (isset($authorValidation['error'])) {
            $errors['author'] = $authorValidation['error'];
        }
        
        // Validate ISBN
        $isbnValidation = self::validate('ISBN', $data['isbn'], 'isbn');
        if (isset($isbnValidation['error'])) {
            $errors['isbn'] = $isbnValidation['error'];
        }
        
        // Validate copies
        if (!isset($data['copies']) || !preg_match(self::PATTERNS['number'], $data['copies']) || $data['copies'] < 1) {
            $errors['copies'] = "Please enter valid number of copies (minimum 1)";
        }
        
        return $errors;
    }
    
    // Validate user registration
    public static function validateUser($data) {
        $errors = [];
        
        // Validate username
        $userValidation = self::validate('Username', $data['username'], 'username');
        if (isset($userValidation['error'])) {
            $errors['username'] = $userValidation['error'];
        }
        
        // Validate email
        $emailValidation = self::validate('Email', $data['email'], 'email');
        if (isset($emailValidation['error'])) {
            $errors['email'] = $emailValidation['error'];
        }
        
        // Validate password
        if (!isset($data['password']) || strlen($data['password']) < 6) {
            $errors['password'] = "Password must be at least 6 characters";
        }
        
        // Validate name
        $nameValidation = self::validate('Full Name', $data['full_name'], 'name');
        if (isset($nameValidation['error'])) {
            $errors['full_name'] = $nameValidation['error'];
        }
        
        return $errors;
    }
    
    // Validate login
    public static function validateLogin($username, $password) {
        $errors = [];
        
        if (empty($username)) {
            $errors['username'] = "Username is required";
        }
        
        if (empty($password)) {
            $errors['password'] = "Password is required";
        } elseif (strlen($password) < 3) {
            $errors['password'] = "Password must be at least 3 characters";
        }
        
        return $errors;
    }
}
?>
</file>

<file path="member/profile.php">
<?php
require_once '../config/db.php';
requireMember();

$user_id = $_SESSION['user_id'];
$error = '';
$success = '';

// Get user details
$sql = "SELECT * FROM users WHERE id = ?";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "i", $user_id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$user = mysqli_fetch_assoc($result);

if($_SERVER["REQUEST_METHOD"] == "POST") {
    $full_name = Validation::sanitize($_POST['full_name']);
    $email = Validation::sanitize($_POST['email']);
    $phone = Validation::sanitize($_POST['phone']);
    $current_password = Validation::sanitize($_POST['current_password'] ?? '');
    $new_password = Validation::sanitize($_POST['new_password'] ?? '');
    $confirm_password = Validation::sanitize($_POST['confirm_password'] ?? '');
    
    // Validate name
    $name_validation = Validation::validate('Full Name', $full_name, 'name');
    if(isset($name_validation['error'])) {
        $error = $name_validation['error'];
    }
    
    // Validate email
    $email_validation = Validation::validate('Email', $email, 'email');
    if(isset($email_validation['error'])) {
        $error = $email_validation['error'];
    }
    
    // Validate phone if provided
    if(!empty($phone)) {
        $phone_validation = Validation::validate('Phone', $phone, 'phone');
        if(isset($phone_validation['error'])) {
            $error = $phone_validation['error'];
        }
    }
    
    // Check password change
    if(!empty($current_password) || !empty($new_password) || !empty($confirm_password)) {
        // Check if current password is correct
        if($current_password !== $user['password']) {
            $error = "Current password is incorrect";
        } elseif($new_password !== $confirm_password) {
            $error = "New passwords do not match";
        } elseif(strlen($new_password) < 6) {
            $error = "New password must be at least 6 characters";
        } else {
            // Update with new password
            $update_password = $new_password;
        }
    }
    
    if(empty($error)) {
        $password_to_use = isset($update_password) ? $update_password : $user['password'];
        
        $update_sql = "UPDATE users SET full_name = ?, email = ?, phone = ?, password = ? WHERE id = ?";
        $update_stmt = mysqli_prepare($conn, $update_sql);
        mysqli_stmt_bind_param($update_stmt, "ssssi", $full_name, $email, $phone, $password_to_use, $user_id);
        
        if(mysqli_stmt_execute($update_stmt)) {
            $success = "Profile updated successfully!";
            // Update session
            $_SESSION['full_name'] = $full_name;
            // Refresh user data
            $user['full_name'] = $full_name;
            $user['email'] = $email;
            $user['phone'] = $phone;
        } else {
            $error = "Error updating profile: " . mysqli_error($conn);
        }
        mysqli_stmt_close($update_stmt);
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Library System</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
    <div class="admin-container">
        <?php include 'member_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>My Profile</h1>
            </div>
            
            <?php if($error): ?>
                <div class="alert alert-error"><?php echo $error; ?></div>
            <?php endif; ?>
            
            <?php if($success): ?>
                <div class="alert alert-success"><?php echo $success; ?></div>
            <?php endif; ?>
            
            <div class="card">
                <form method="POST" onsubmit="return validateProfileForm()">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" class="form-control" 
                                   value="<?php echo htmlspecialchars($user['username']); ?>" readonly>
                            <small class="help-text">Username cannot be changed</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="full_name">Full Name *</label>
                            <input type="text" id="full_name" name="full_name" class="form-control" 
                                   value="<?php echo htmlspecialchars($user['full_name']); ?>" required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" class="form-control" 
                                   value="<?php echo htmlspecialchars($user['email']); ?>" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-control" 
                                   value="<?php echo htmlspecialchars($user['phone'] ?? ''); ?>">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="role">Account Type</label>
                            <input type="text" id="role" class="form-control" 
                                   value="<?php echo ucfirst($user['role']); ?>" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="join_date">Member Since</label>
                            <input type="text" id="join_date" class="form-control" 
                                   value="<?php echo date('F j, Y', strtotime($user['created_at'])); ?>" readonly>
                        </div>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h3>Change Password (Optional)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="current_password">Current Password</label>
                            <input type="password" id="current_password" name="current_password" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="new_password">New Password</label>
                            <input type="password" id="new_password" name="new_password" class="form-control">
                            <small class="help-text">Leave empty if not changing</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm_password">Confirm New Password</label>
                            <input type="password" id="confirm_password" name="confirm_password" class="form-control">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
    function validateProfileForm() {
        let fullName = document.getElementById('full_name');
        let email = document.getElementById('email');
        let phone = document.getElementById('phone');
        let newPassword = document.getElementById('new_password');
        let confirmPassword = document.getElementById('confirm_password');
        
        // Clear previous errors
        document.querySelectorAll('.invalid-feedback').forEach(el => {
            el.classList.remove('show');
        });
        document.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
        
        let isValid = true;
        
        // Validate full name
        if(!fullName.value.trim()) {
            showError(fullName, "Full name is required");
            isValid = false;
        } else if(!/^[a-zA-Z\s]{2,50}$/.test(fullName.value)) {
            showError(fullName, "Full name must be 2-50 letters and spaces only");
            isValid = false;
        }
        
        // Validate email
        if(!email.value.trim()) {
            showError(email, "Email is required");
            isValid = false;
        } else if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email.value)) {
            showError(email, "Enter a valid email address");
            isValid = false;
        }
        
        // Validate phone if provided
        if(phone.value.trim() && !/^[6-9]\d{9}$/.test(phone.value)) {
            showError(phone, "Enter a valid 10-digit mobile number");
            isValid = false;
        }
        
        // Validate password if changing
        if(newPassword.value || confirmPassword.value) {
            if(newPassword.value !== confirmPassword.value) {
                showError(confirmPassword, "Passwords do not match");
                isValid = false;
            }
            if(newPassword.value && newPassword.value.length < 6) {
                showError(newPassword, "Password must be at least 6 characters");
                isValid = false;
            }
        }
        
        return isValid;
    }
    
    function showError(element, message) {
        element.classList.add('is-invalid');
        let feedback = element.nextElementSibling;
        if(feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.textContent = message;
            feedback.classList.add('show');
        }
    }
    </script>
</body>
</html>
</file>

<file path="admin/add_member.php">
<?php
require_once '../config/db.php';
requireAdmin();

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $username   = $_POST['username'];
    $password   = $_POST['password'];
    $full_name  = $_POST['full_name'];
    $email      = $_POST['email'];
    $phone      = $_POST['phone'];

    $check = mysqli_query($conn, "SELECT id FROM users WHERE username = '$username' OR email = '$email'");
    if (mysqli_num_rows($check) > 0) {
        setAlert('error', 'Error', 'Username or email already exists');
    } else {
        $hashed = password_hash($password, PASSWORD_DEFAULT);
        $sql = "INSERT INTO users (username, password, full_name, email, phone, role) VALUES (?, ?, ?, ?, ?, 'member')";
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, "sssss", $username, $hashed, $full_name, $email, $phone);

        if (mysqli_stmt_execute($stmt)) {
            setAlert('success', 'Success', 'Student added successfully');
            header("Location: manage_members.php");
            exit;
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Add Student</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
<div class="admin-container">
    <?php include '../includes/admin_sidebar.php'; ?>
    <div class="main-content">
        <div class="content-header">
            <h1>Add New Student</h1>
            <a href="manage_members.php" class="btn">Back</a>
        </div>
        <div class="card">
            <form method="POST">
                <div class="form-row">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" name="username" class="form-control" 
                               pattern="[a-zA-Z0-9_]{3,20}" 
                               title="3-20 characters, no spaces."
                               required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" name="password" class="form-control" 
                               pattern=".{6,}" 
                               title="Min 6 characters."
                               required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="full_name" class="form-control" 
                           pattern="[a-zA-Z\s]+" 
                           title="Letters and spaces only."
                           required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" name="phone" class="form-control" 
                               pattern="[0-9]{10}" 
                               title="10 digit phone number"
                               required>
                    </div>
                </div>

                <button class="btn btn-primary">Add Student</button>
            </form>
        </div>
    </div>
</div>
<?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="admin/ajax_add_category.php">
<?php
require_once '../config/db.php';
requireAdmin();

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['name'])) {
    $name = mysqli_real_escape_string($conn, trim($_POST['name']));
    
    if (!empty($name)) {
        // Check if exists
        $check = mysqli_query($conn, "SELECT id FROM categories WHERE name = '$name'");
        if (mysqli_num_rows($check) > 0) {
            echo json_encode(['status' => 'error', 'message' => 'Category already exists']);
        } else {
            if (mysqli_query($conn, "INSERT INTO categories (name) VALUES ('$name')")) {
                echo json_encode(['status' => 'success', 'name' => $name]);
            } else {
                echo json_encode(['status' => 'error', 'message' => 'Database error']);
            }
        }
    }
    exit;
}
</file>

<file path="admin/browse_categories.php">
<?php
require_once '../config/db.php';
requireAdmin();

// Count books per category
$sql = "SELECT c.name, COUNT(b.id) as book_count 
        FROM categories c 
        LEFT JOIN books b ON c.name = b.category 
        GROUP BY c.id, c.name 
        ORDER BY c.name ASC";
$result = mysqli_query($conn, $sql);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Browse Categories</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .category-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text);
            border: 1px solid transparent;
        }
        .category-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.15);
        }
        .cat-icon {
            font-size: 30px;
            color: var(--primary);
            margin-bottom: 15px;
            background: rgba(67, 97, 238, 0.1);
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            margin-left: auto;
            margin-right: auto;
        }
        .cat-count {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Browse by Category</h1>
                <a href="manage_categories.php" class="btn btn-secondary">
                    <i class="fas fa-cog"></i> Manage Categories
                </a>
            </div>

            <div class="category-grid">
                <?php while($row = mysqli_fetch_assoc($result)): ?>
                <a href="manage_book.php?category=<?= urlencode($row['name']) ?>" class="category-card">
                    <div class="cat-icon"><i class="fas fa-bookmark"></i></div>
                    <h3 style="margin:0; font-size: 18px;"><?= htmlspecialchars($row['name']) ?></h3>
                    <div class="cat-count"><?= $row['book_count'] ?> Books</div>
                </a>
                <?php endwhile; ?>
            </div>
        </div>
    </div>
</body>
</html>
</file>

<file path="admin/manage_requests.php">
<?php
require_once '../config/db.php';
requireAdmin();

// Handle Approve / Reject
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['action']) && isset($_POST['request_id'])) {
    verify_csrf();
    $req_id = (int)$_POST['request_id'];
    $action = $_POST['action'];

    if ($action === 'approve') {
        // Fetch request details
        $req_info = mysqli_fetch_assoc(mysqli_query($conn, "SELECT user_id, book_id FROM book_requests WHERE id = $req_id AND status = 'pending'"));
        if($req_info) {
            $book_id = $req_info['book_id'];
            $user_id = $req_info['user_id'];
            
            // Look for an available physical copy
            $copy = mysqli_fetch_assoc(mysqli_query($conn, "SELECT id FROM book_copies WHERE book_id = $book_id AND status = 'available' LIMIT 1"));
            
            if($copy) {
                $copy_id = $copy['id'];
                $due_date = date('Y-m-d', strtotime('+15 days')); // Default 15 days borrowing period
                
                mysqli_begin_transaction($conn);
                try {
                    // Issue the book
                    mysqli_query($conn, "INSERT INTO issued_books (book_id, copy_id, user_id, issue_date, due_date, status) VALUES ($book_id, $copy_id, $user_id, CURDATE(), '$due_date', 'issued')");
                    mysqli_query($conn, "UPDATE book_copies SET status='issued' WHERE id=$copy_id");
                    mysqli_query($conn, "UPDATE books SET available_copies=available_copies-1 WHERE id=$book_id");
                    
                    // Mark request as approved
                    mysqli_query($conn, "UPDATE book_requests SET status = 'approved' WHERE id = $req_id");
                    
                    mysqli_commit($conn);
                    setAlert('success', 'Approved', 'Request approved. Book has been issued!');
                } catch (Exception $e) {
                    mysqli_rollback($conn);
                    setAlert('error', 'Error', 'Failed to issue the book.');
                }
            } else {
                setAlert('error', 'Out of Stock', 'No copies available to issue right now.');
            }
        }
    } elseif ($action === 'reject') {
        mysqli_query($conn, "UPDATE book_requests SET status = 'rejected' WHERE id = $req_id");
        setAlert('success', 'Rejected', 'Request has been rejected.');
    }
    
    header("Location: manage_requests.php");
    exit;
}

$sql = "SELECT br.*, b.title, u.full_name, u.username, b.available_copies
        FROM book_requests br 
        JOIN books b ON br.book_id = b.id 
        JOIN users u ON br.user_id = u.id
        ORDER BY FIELD(br.status, 'pending', 'approved', 'rejected'), br.request_date DESC";
$result = mysqli_query($conn, $sql);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Manage Book Requests</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="admin-container">
    <?php include '../includes/admin_sidebar.php'; ?>

    <div class="main-content">
        <div class="content-header">
            <h1>Manage Book Requests</h1>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Requested Book</th>
                            <th>Stock</th>
                            <th>Date</th>
                            <th>Status / Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?php if (mysqli_num_rows($result) > 0): ?>
                        <?php while ($row = mysqli_fetch_assoc($result)): ?>
                        <tr>
                            <td>
                                <strong><?= htmlspecialchars($row['full_name']) ?></strong><br>
                                <small><?= htmlspecialchars($row['username']) ?></small>
                            </td>
                            <td style="font-weight:600"><?= htmlspecialchars($row['title']) ?></td>
                            <td>
                                <?php if($row['available_copies'] > 0): ?>
                                    <span class="badge badge-success"><?= $row['available_copies'] ?> Available</span>
                                <?php else: ?>
                                    <span class="badge badge-danger">Out of Stock</span>
                                <?php endif; ?>
                            </td>
                            <td><?= date('M d, Y h:i A', strtotime($row['request_date'])) ?></td>
                            <td>
                                <?php if($row['status'] == 'pending'): ?>
                                    <form method="POST" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                                        <input type="hidden" name="request_id" value="<?= $row['id'] ?>">
                                        
                                        <button type="submit" name="action" value="approve" class="btn btn-success" style="padding: 5px 10px; font-size:12px;" <?= ($row['available_copies'] <= 0) ? 'disabled' : '' ?>>
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        
                                        <button type="submit" name="action" value="reject" class="btn btn-danger" style="padding: 5px 10px; font-size:12px;" onclick="return confirm('Are you sure you want to reject this request?');">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </form>
                                <?php elseif($row['status'] == 'approved'): ?>
                                    <span class="badge badge-success">Approved</span>
                                <?php else: ?>
                                    <span class="badge badge-danger">Rejected</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endwhile; ?>
                    <?php else: ?>
                        <tr><td colspan="5" class="text-center">No requests found.</td></tr>
                    <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="admin/profile.php">
<?php
require_once '../config/db.php';
requireAdmin();

$user_id = $_SESSION['user_id'];
$error = '';
$success = '';

// 1. Fetch current Admin details
$sql = "SELECT * FROM users WHERE id = ?";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "i", $user_id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$admin = mysqli_fetch_assoc($result);

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    verify_csrf();
    
    $full_name = trim($_POST['full_name']);
    $email = trim($_POST['email']);
    $phone = trim($_POST['phone']);
    $new_password = $_POST['new_password'];
    $confirm_password = $_POST['confirm_password'];

    // Basic Validation
    if (empty($full_name) || empty($email)) {
        $error = "Name and Email are required.";
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $error = "Invalid email format.";
    } else {
        // Password logic
        $password_update_sql = "";
        if (!empty($new_password)) {
            if (strlen($new_password) < 6) {
                $error = "New password must be at least 6 characters.";
            } elseif ($new_password !== $confirm_password) {
                $error = "Passwords do not match.";
            } else {
                $hashed_pw = password_hash($new_password, PASSWORD_DEFAULT);
                $password_update_sql = ", password = '$hashed_pw'";
            }
        }

        if (empty($error)) {
            $update_sql = "UPDATE users SET full_name = ?, email = ?, phone = ? $password_update_sql WHERE id = ?";
            $stmt_update = mysqli_prepare($conn, $update_sql);
            mysqli_stmt_bind_param($stmt_update, "sssi", $full_name, $email, $phone, $user_id);

            if (mysqli_stmt_execute($stmt_update)) {
                $_SESSION['full_name'] = $full_name; // Update session name
                setAlert('success', 'Updated', 'Profile updated successfully!');
                header("Location: profile.php");
                exit;
            } else {
                $error = "Database error: " . mysqli_error($conn);
            }
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin Profile</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Manage Profile</h1>
            </div>

            <?php if($error): ?>
                <div class="card" style="background: #fff5f5; border-left: 5px solid #f72585; color: #f72585; padding: 15px; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle"></i> <?= $error ?>
                </div>
            <?php endif; ?>

            <div class="card">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                    
                    <div class="form-row" style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Username (Read Only)</label>
                            <input type="text" class="form-control" value="<?= htmlspecialchars($admin['username']) ?>" readonly style="background: #eee;">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Full Name</label>
                            <input type="text" name="full_name" class="form-control" value="<?= htmlspecialchars($admin['full_name']) ?>" required>
                        </div>
                    </div>

                    <div class="form-row" style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Email Address</label>
                            <input type="email" name="email" class="form-control" value="<?= htmlspecialchars($admin['email']) ?>" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Phone Number</label>
                            <input type="text" name="phone" class="form-control" value="<?= htmlspecialchars($admin['phone']) ?>">
                        </div>
                    </div>

                    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">
                    
                    <h3>Change Password</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Leave password fields blank if you don't want to change it.</p>

                    <div class="form-row" style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>New Password</label>
                            <input type="password" name="new_password" class="form-control" placeholder="Min 6 characters">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Confirm New Password</label>
                            <input type="password" name="confirm_password" class="form-control">
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="admin/reports.php">
<?php
require_once '../config/db.php';
requireAdmin();

// Default Dates: First day of this month to Today
$start_date = $_GET['start_date'] ?? date('Y-m-01');
$end_date   = $_GET['end_date'] ?? date('Y-m-d');
$report_type = $_GET['report_type'] ?? 'issue_history';

$results = null;

// Logic based on Report Type
if ($report_type == 'issue_history') {
    // Shows who took what book within the date range
    $sql = "SELECT ib.*, b.title, u.full_name, u.username, bc.unique_code 
            FROM issued_books ib 
            JOIN books b ON ib.book_id = b.id 
            JOIN users u ON ib.user_id = u.id 
            LEFT JOIN book_copies bc ON ib.copy_id = bc.id
            WHERE ib.issue_date BETWEEN '$start_date' AND '$end_date'
            ORDER BY ib.issue_date DESC";
    $results = mysqli_query($conn, $sql);

} elseif ($report_type == 'overdue') {
    // Shows currently overdue books
    $sql = "SELECT ib.*, b.title, u.full_name, u.phone, bc.unique_code 
            FROM issued_books ib 
            JOIN books b ON ib.book_id = b.id 
            JOIN users u ON ib.user_id = u.id 
            LEFT JOIN book_copies bc ON ib.copy_id = bc.id
            WHERE ib.status = 'issued' AND ib.due_date < CURDATE()
            ORDER BY ib.due_date ASC";
    $results = mysqli_query($conn, $sql);

} elseif ($report_type == 'top_books') {
    // Shows which books are most popular
    $sql = "SELECT b.title, b.author, COUNT(ib.id) as issue_count 
            FROM issued_books ib 
            JOIN books b ON ib.book_id = b.id 
            GROUP BY ib.book_id 
            ORDER BY issue_count DESC 
            LIMIT 20";
    $results = mysqli_query($conn, $sql);
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Library Reports</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Library Reports</h1>
                <button onclick="window.print()" class="btn btn-primary no-print">
                    <i class="fas fa-print"></i> Print / Save PDF
                </button>
            </div>

            <!-- Filter Form (Hidden when printing) -->
            <div class="card no-print">
                <form method="GET" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Report Type</label>
                        <select name="report_type" class="form-control" onchange="this.form.submit()">
                            <option value="issue_history" <?= $report_type=='issue_history'?'selected':'' ?>>Issue History</option>
                            <option value="overdue" <?= $report_type=='overdue'?'selected':'' ?>>Overdue Books</option>
                            <option value="top_books" <?= $report_type=='top_books'?'selected':'' ?>>Most Popular Books</option>
                        </select>
                    </div>

                    <?php if($report_type != 'overdue' && $report_type != 'top_books'): ?>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>From Date</label>
                        <input type="date" name="start_date" value="<?= $start_date ?>" class="form-control">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>To Date</label>
                        <input type="date" name="end_date" value="<?= $end_date ?>" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Filter</button>
                    <?php endif; ?>
                </form>
            </div>

            <!-- Report Results -->
            <div class="card">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2>
                        <?php 
                        if($report_type == 'issue_history') echo "Issue History Report";
                        elseif($report_type == 'overdue') echo "Overdue Books Report";
                        else echo "Top Issued Books";
                        ?>
                    </h2>
                    <p style="color: #666;">
                        Generated on: <?= date('d M Y') ?> 
                        <?php if($report_type == 'issue_history'): ?>
                            <br>Period: <?= date('d M Y', strtotime($start_date)) ?> to <?= date('d M Y', strtotime($end_date)) ?>
                        <?php endif; ?>
                    </p>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered">
                        
                        <!-- 1. ISSUE HISTORY TABLE -->
                        <?php if($report_type == 'issue_history'): ?>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Book Title</th>
                                <th>Unique Code</th>
                                <th>Student</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php while($row = mysqli_fetch_assoc($results)): ?>
                            <tr>
                                <td><?= date('d-m-Y', strtotime($row['issue_date'])) ?></td>
                                <td><?= htmlspecialchars($row['title']) ?></td>
                                <td style="font-family: monospace;"><?= htmlspecialchars($row['unique_code'] ?? 'N/A') ?></td>
                                <td><?= htmlspecialchars($row['full_name']) ?> (<?= $row['username'] ?>)</td>
                                <td>
                                    <?php if($row['status'] == 'returned'): ?>
                                        <span style="color: green;">Returned (<?= date('d-m-Y', strtotime($row['return_date'])) ?>)</span>
                                    <?php else: ?>
                                        <span style="color: orange;">Issued</span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                            <?php endwhile; ?>
                        </tbody>

                        <!-- 2. OVERDUE TABLE -->
                        <?php elseif($report_type == 'overdue'): ?>
                        <thead>
                            <tr>
                                <th>Due Date</th>
                                <th>Book Title</th>
                                <th>Unique Code</th>
                                <th>Student</th>
                                <th>Phone</th>
                                <th>Days Late</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php 
                            if(mysqli_num_rows($results) > 0):
                            while($row = mysqli_fetch_assoc($results)): 
                                $days_late = floor((time() - strtotime($row['due_date'])) / (60 * 60 * 24));
                            ?>
                            <tr>
                                <td style="color: red; font-weight: bold;"><?= date('d-m-Y', strtotime($row['due_date'])) ?></td>
                                <td><?= htmlspecialchars($row['title']) ?></td>
                                <td style="font-family: monospace;"><?= htmlspecialchars($row['unique_code'] ?? 'N/A') ?></td>
                                <td><?= htmlspecialchars($row['full_name']) ?></td>
                                <td><?= htmlspecialchars($row['phone'] ?? 'N/A') ?></td>
                                <td style="color: red;"><?= $days_late ?> Days</td>
                            </tr>
                            <?php endwhile; else: ?>
                                <tr><td colspan="6" class="text-center">No overdue books found!</td></tr>
                            <?php endif; ?>
                        </tbody>

                        <!-- 3. TOP BOOKS TABLE -->
                        <?php elseif($report_type == 'top_books'): ?>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Book Title</th>
                                <th>Author</th>
                                <th>Times Issued</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php 
                            $rank = 1;
                            while($row = mysqli_fetch_assoc($results)): 
                            ?>
                            <tr>
                                <td>#<?= $rank++ ?></td>
                                <td style="font-weight: bold;"><?= htmlspecialchars($row['title']) ?></td>
                                <td><?= htmlspecialchars($row['author']) ?></td>
                                <td><?= $row['issue_count'] ?> times</td>
                            </tr>
                            <?php endwhile; ?>
                        </tbody>
                        <?php endif; ?>

                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
</file>

<file path="auth/forget_password.php">
<?php
require_once '../config/db.php';

$error = '';
$success = '';
$debug_link = ''; // To show link on localhost since email won't work without SMTP

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $email = mysqli_real_escape_string($conn, $_POST['email']);

    // Check if email exists
    $sql = "SELECT id FROM users WHERE email = ?";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, "s", $email);
    mysqli_stmt_execute($stmt);
    mysqli_stmt_store_result($stmt);

    if (mysqli_stmt_num_rows($stmt) > 0) {
        // 1. Generate secure token
        $token = bin2hex(random_bytes(16));
        $token_hash = hash("sha256", $token);
        $expiry = date("Y-m-d H:i:s", time() + 60 * 30); // 30 minutes from now

        // 2. Store hash in DB
        $update = "UPDATE users SET reset_token_hash = ?, reset_token_expires_at = ? WHERE email = ?";
        $stmt = mysqli_prepare($conn, $update);
        mysqli_stmt_bind_param($stmt, "sss", $token_hash, $expiry, $email);
        mysqli_stmt_execute($stmt);

        // 3. Create Link
        // Adjust 'localhost/library...' to match your actual folder structure
        $actual_link = "http://" . $_SERVER['HTTP_HOST'] . dirname($_SERVER['PHP_SELF']) . "/reset_password.php?token=" . $token;

        // 4. Simulate Email Sending
        $to = $email;
        $subject = "Password Reset";
        $message = "Click here to reset: " . $actual_link;
        $headers = "From: no-reply@library.com";

        // Try sending email (might fail on localhost)
        if(@mail($to, $subject, $message, $headers)) {
            $success = "Reset link sent to your email.";
        } else {
            $success = "Reset link generated (Email failed on localhost).";
            // FOR DEVELOPMENT ONLY: Show link directly
            $debug_link = $actual_link;
        }
    } else {
        // Security: Don't reveal if email doesn't exist
        $error = "If that email exists, we have sent a reset link.";
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Forgot Password</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/auth.css">
</head>
<body>
<div class="auth-container">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Forgot Password</h2>
            <p>Enter your email to receive a reset link</p>
        </div>

        <?php if ($error): ?><div class="alert alert-error"><?= $error ?></div><?php endif; ?>
        <?php if ($success): ?><div class="alert alert-success"><?= $success ?></div><?php endif; ?>

        <!-- DEV ONLY: Show link for testing -->
        <?php if ($debug_link): ?>
            <div class="alert" style="background:#e8f4fd; color:#0c5460; font-size:13px; word-break:break-all;">
                <strong>Localhost Dev Link:</strong><br>
                <a href="<?= $debug_link ?>">Click here to Reset Password</a>
            </div>
        <?php endif; ?>

        <form class="auth-form" method="POST">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-primary">Send Reset Link</button>
            
            <div class="auth-footer">
                <a href="login.php">Back to Login</a>
            </div>
        </form>
    </div>
</div>
</body>
</html>
</file>

<file path="auth/logout.php">
<?php
session_start();

// Unset all session variables
$_SESSION = array();

// Destroy the session
session_destroy();

// Redirect to login page
header("Location: login.php");
exit;
?>
</file>

<file path="auth/reset_password.php">
<?php
require_once '../config/db.php';

$error = '';
$success = '';
$token = $_GET['token'] ?? '';

if (!$token) {
    die("Invalid token");
}

$token_hash = hash("sha256", $token);

// 1. Check if token is valid and not expired
$sql = "SELECT id FROM users WHERE reset_token_hash = ? AND reset_token_expires_at > NOW()";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "s", $token_hash);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$user = mysqli_fetch_assoc($result);

if (!$user) {
    die("Link is invalid or has expired.");
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $pass = $_POST['password'];
    $confirm = $_POST['confirm_password'];

    if ($pass !== $confirm) {
        $error = "Passwords do not match";
    } elseif (strlen($pass) < 6) {
        $error = "Password must be at least 6 characters";
    } else {
        // 2. Update Password
        $hashed_password = password_hash($pass, PASSWORD_DEFAULT);
        
        $update = "UPDATE users SET password = ?, reset_token_hash = NULL, reset_token_expires_at = NULL WHERE id = ?";
        $stmt = mysqli_prepare($conn, $update);
        mysqli_stmt_bind_param($stmt, "si", $hashed_password, $user['id']);
        
        if (mysqli_stmt_execute($stmt)) {
            $success = "Password reset successfully! <a href='login.php'>Login now</a>";
        } else {
            $error = "Error updating password.";
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Reset Password</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/auth.css">
</head>
<body>
<div class="auth-container">
    <div class="auth-box">
        <h2>Reset Password</h2>
        
        <?php if ($error): ?><div class="alert alert-error"><?= $error ?></div><?php endif; ?>
        <?php if ($success): ?><div class="alert alert-success"><?= $success ?></div><?php endif; ?>

        <?php if (empty($success)): ?>
        <form class="auth-form" method="POST">
            <div class="form-group">
                <label>New Password</label>
                <input type="password" name="password" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" name="confirm_password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Reset Password</button>
        </form>
        <?php endif; ?>
    </div>
</div>
</body>
</html>
</file>

<file path="config/reset_dmin.php">
<?php
require_once '../config/db.php';

// The username you want to fix
$username = 'super_admin'; 
// The new password you want
$new_pass = '1234';

// 1. Encrypt password using YOUR system's algorithm
$hash = password_hash($new_pass, PASSWORD_DEFAULT);

// 2. Update database
$sql = "UPDATE users SET password = '$hash', role = 'admin' WHERE username = '$username'";

if(mysqli_query($conn, $sql)) {
    echo "<h1>Success!</h1>";
    echo "Username: <b>$username</b><br>";
    echo "Password: <b>$new_pass</b><br>";
    echo "Role: <b>admin</b><br><br>";
    echo "<a href='../auth/login.php'>Go to Login</a>";
} else {
    echo "Error: " . mysqli_error($conn);
}
?>
</file>

<file path="includes/footer.php">
<footer style="background: #2c3e50; color: white; padding: 30px 0; margin-top: 50px;">
    <div class="container">
        <p style="text-align: center;">¬© <?php echo date('Y'); ?> Library Management System | 4th Semester Project</p>
    </div>
</footer>

<!-- Custom Alert HTML Container -->
<div id="custom-alert" class="custom-alert">
    <div class="alert-icon" id="alert-icon" style="font-size: 24px;"></div>
    <div class="alert-content">
        <h4 id="alert-title">Title</h4>
        <p id="alert-message">Message goes here...</p>
    </div>
</div>

<script>
    // Custom JS for Alerts (No Libraries)
    function showAlert(type, title, message) {
        const alertBox = document.getElementById('custom-alert');
        const alertTitle = document.getElementById('alert-title');
        const alertMsg = document.getElementById('alert-message');
        const alertIcon = document.getElementById('alert-icon');
        
        // Reset classes
        alertBox.className = 'custom-alert ' + type;
        
        // Set Content
        alertTitle.textContent = title;
        alertMsg.textContent = message;
        
        // Set Icon
        if(type === 'success') alertIcon.innerHTML = '‚úÖ';
        else if(type === 'error') alertIcon.innerHTML = '‚ùå';
        else alertIcon.innerHTML = '‚ÑπÔ∏è';

        // Show
        setTimeout(() => { alertBox.classList.add('show'); }, 100);

        // Hide after 3 seconds
        setTimeout(() => {
            alertBox.classList.remove('show');
        }, 3000);
    }

    // Trigger Alert from PHP Session
    <?php if (isset($_SESSION['alert'])): ?>
        showAlert('<?php echo $_SESSION['alert']['type']; ?>', 
                  '<?php echo $_SESSION['alert']['title']; ?>', 
                  '<?php echo $_SESSION['alert']['message']; ?>');
        <?php unset($_SESSION['alert']); ?>
    <?php endif; ?>
</script>
</body>
</html>
</file>

<file path="member/browse_categories.php">
<?php
require_once '../config/db.php';
requireMember();

// Fetch categories and count books in each
$sql = "SELECT c.name, COUNT(b.id) as book_count 
        FROM categories c 
        LEFT JOIN books b ON c.name = b.category 
        GROUP BY c.id, c.name 
        ORDER BY c.name ASC";
$result = mysqli_query($conn, $sql);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Browse Categories</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .category-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text);
            border: 1px solid transparent;
            display: block;
        }
        .category-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.15);
        }
        .cat-icon {
            font-size: 30px;
            color: var(--primary);
            margin-bottom: 15px;
            background: rgba(67, 97, 238, 0.1);
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            margin-left: auto;
            margin-right: auto;
        }
        .cat-count {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <?php include 'member_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Browse by Category</h1>
            </div>

            <div class="category-grid">
                <?php if(mysqli_num_rows($result) > 0): ?>
                    <?php while($row = mysqli_fetch_assoc($result)): ?>
                    <a href="books.php?category=<?= urlencode($row['name']) ?>" class="category-card">
                        <div class="cat-icon"><i class="fas fa-bookmark"></i></div>
                        <h3 style="margin:0; font-size: 18px;"><?= htmlspecialchars($row['name']) ?></h3>
                        <div class="cat-count"><?= $row['book_count'] ?> Books</div>
                    </a>
                    <?php endwhile; ?>
                <?php else: ?>
                    <p>No categories found.</p>
                <?php endif; ?>
            </div>
        </div>
    </div>
</body>
</html>
</file>

<file path="member/my_requests.php">
<?php
require_once '../config/db.php';
requireMember();

$user_id = $_SESSION['user_id'];

$sql = "SELECT br.*, b.title, b.author 
        FROM book_requests br 
        JOIN books b ON br.book_id = b.id 
        WHERE br.user_id = ? 
        ORDER BY br.request_date DESC";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "i", $user_id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Book Requests</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="admin-container">
    <?php include 'member_sidebar.php'; ?>

    <div class="main-content">
        <div class="content-header">
            <h1>My Book Requests</h1>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Author</th>
                            <th>Requested On</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?php if (mysqli_num_rows($result) > 0): ?>
                        <?php while ($row = mysqli_fetch_assoc($result)): ?>
                        <tr>
                            <td style="font-weight:600"><?= htmlspecialchars($row['title']) ?></td>
                            <td><?= htmlspecialchars($row['author']) ?></td>
                            <td><?= date('M d, Y h:i A', strtotime($row['request_date'])) ?></td>
                            <td>
                                <?php if($row['status'] == 'pending'): ?>
                                    <span class="badge badge-warning">Pending</span>
                                <?php elseif($row['status'] == 'approved'): ?>
                                    <span class="badge badge-success">Approved (Issued)</span>
                                <?php elseif($row['status'] == 'rejected'): ?>
                                    <span class="badge badge-danger">Rejected</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endwhile; ?>
                    <?php else: ?>
                        <tr><td colspan="4" class="text-center">You have no book requests.</td></tr>
                    <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="member/request_book.php">
<?php
require_once '../config/db.php';
requireMember();

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['book_id'])) {
    verify_csrf();
    $book_id = (int)$_POST['book_id'];
    $user_id = $_SESSION['user_id'];

    // Check if already requested and pending
    $check = mysqli_query($conn, "SELECT id FROM book_requests WHERE user_id = $user_id AND book_id = $book_id AND status = 'pending'");
    
    if (mysqli_num_rows($check) > 0) {
        setAlert('error', 'Already Requested', 'You already have a pending request for this book.');
    } else {
        mysqli_query($conn, "INSERT INTO book_requests (user_id, book_id) VALUES ($user_id, $book_id)");
        setAlert('success', 'Success', 'Book requested successfully! A librarian will review your request.');
    }
    header("Location: view_book.php?id=" . $book_id);
    exit;
}

header("Location: books.php");
exit;
?>
</file>

<file path="member/viewBook.php">
<?php
require_once '../config/db.php';
requireMember();

if (!isset($_GET['id'])) {
    header("Location: books.php");
    exit;
}

$book_id = (int)$_GET['id'];
$user_id = $_SESSION['user_id'];

// 1. Fetch Book Details
$sql = "SELECT * FROM books WHERE id = ?";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "i", $book_id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$book = mysqli_fetch_assoc($result);

if (!$book) {
    echo "Book not found.";
    exit;
}

// 2. Check if the current user has this book issued
$status_sql = "SELECT * FROM issued_books WHERE user_id = ? AND book_id = ? AND status = 'issued'";
$stmt2 = mysqli_prepare($conn, $status_sql);
mysqli_stmt_bind_param($stmt2, "ii", $user_id, $book_id);
mysqli_stmt_execute($stmt2);
$is_borrowed = mysqli_stmt_fetch($stmt2);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($book['title']) ?> - Details</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="admin-container">
    <?php include 'member_sidebar.php'; ?>

    <div class="main-content">
        <div class="content-header">
            <a href="books.php" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to List</a>
        </div>

        <div class="card" style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1 style="margin-bottom: 10px; color: var(--primary);"><?= htmlspecialchars($book['title']) ?></h1>
                    <h3 style="color: #7f8c8d; font-weight: 500;">by <?= htmlspecialchars($book['author']) ?></h3>
                </div>
                
                <!-- Availability Badge -->
                <div style="text-align: right;">
                    <?php if($book['available_copies'] > 0): ?>
                        <span class="badge badge-success" style="font-size: 14px; padding: 10px 15px;">
                            <i class="fas fa-check-circle"></i> Available
                        </span>
                    <?php else: ?>
                        <span class="badge badge-danger" style="font-size: 14px; padding: 10px 15px;">
                            <i class="fas fa-times-circle"></i> Out of Stock
                        </span>
                    <?php endif; ?>
                </div>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

            <!-- User Borrow Status Notification -->
            <?php if($is_borrowed): ?>
                <div class="alert alert-warning" style="background: #fff3cd; color: #856404; border: 1px solid #ffeeba;">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> You currently have a copy of this book borrowed. 
                    <a href="issued_books.php">Check Due Date</a>
                </div>
            <?php endif; ?>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                <!-- Left Column -->
                <div>
                    <p><strong>Category:</strong> <br> <?= htmlspecialchars($book['category']) ?></p>
                    <p style="margin-top: 15px;"><strong>ISBN:</strong> <br> <span style="font-family: monospace; background: #f8f9fa; padding: 2px 6px;"><?= htmlspecialchars($book['isbn']) ?></span></p>
                </div>

                <!-- Right Column -->
                <div>
                    <p><strong>Stock Info:</strong></p>
                    <ul style="list-style: none; padding: 0; color: #666;">
                        <li>Total Copies: <?= $book['total_copies'] ?></li>
                        <li>Currently Available: <strong><?= $book['available_copies'] ?></strong></li>
                    </ul>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 10px;">Description</h4>
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; line-height: 1.6; color: #444;">
                    <?php 
                    if (!empty($book['description'])) {
                        echo nl2br(htmlspecialchars($book['description'])); 
                    } else {
                        echo "<em>No description available for this book.</em>";
                    }
                    ?>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .badge-success { background: #d4edda; color: #155724; }
    .badge-danger { background: #f8d7da; color: #721c24; }
</style>

</body>
</html>
</file>

<file path="README.md">
# project-I-library-Management-system-
4 semester main project
</file>

<file path="admin/fix_code.php">
<?php
// admin/fix_codes.php
require_once '../config/db.php';

echo "<h1>Generating Unique Codes for Existing Books...</h1>";

// 1. Get all books
$sql = "SELECT * FROM books";
$result = mysqli_query($conn, $sql);

if (mysqli_num_rows($result) > 0) {
    while ($book = mysqli_fetch_assoc($result)) {
        $book_id = $book['id'];
        $isbn = $book['isbn'];
        $total_copies = $book['total_copies'];
        
        // 2. Check if this book already has copies in the new table
        $check_sql = "SELECT COUNT(*) as count FROM book_copies WHERE book_id = $book_id";
        $check_res = mysqli_query($conn, $check_sql);
        $count_data = mysqli_fetch_assoc($check_res);
        
        if ($count_data['count'] == 0) {
            // 3. If no copies exist, create them
            echo "Processing: <strong>" . $book['title'] . "</strong> ($total_copies copies)<br>";
            
            for ($i = 1; $i <= $total_copies; $i++) {
                // Generate Unique Code
                $random_str = strtoupper(substr(md5(time() . rand()), 0, 4));
                $unique_code = $isbn . "-" . $random_str . "-" . $i;
                
                // Insert
                $insert_sql = "INSERT INTO book_copies (book_id, unique_code, status) VALUES ('$book_id', '$unique_code', 'available')";
                if (mysqli_query($conn, $insert_sql)) {
                    echo "&nbsp;&nbsp;&nbsp; - Generated Code: $unique_code <span style='color:green'>[OK]</span><br>";
                } else {
                    echo "&nbsp;&nbsp;&nbsp; - Error: " . mysqli_error($conn) . "<br>";
                }
            }
            echo "<hr>";
        } else {
            echo "Skipping: " . $book['title'] . " (Codes already exist)<br><hr>";
        }
    }
    echo "<h2>Done! You can now delete this file and go to Issue Book page.</h2>";
} else {
    echo "No books found in database.";
}
?>
</file>

<file path="admin/manage_categories.php">
<?php
require_once '../config/db.php';
requireAdmin();

// Handle Add
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['add_cat'])) {
    verify_csrf();
    $name = mysqli_real_escape_string($conn, trim($_POST['name']));
    
    if(!empty($name)) {
        // Check duplicate
        $check = mysqli_query($conn, "SELECT id FROM categories WHERE name = '$name'");
        if(mysqli_num_rows($check) > 0) {
            setAlert('error', 'Error', 'Category already exists');
        } else {
            mysqli_query($conn, "INSERT INTO categories (name) VALUES ('$name')");
            setAlert('success', 'Success', 'Category added');
            header("Location: manage_categories.php");
            exit;
        }
    }
}

// Handle Delete
if (isset($_GET['delete'])) {
    $id = (int)$_GET['delete'];
    mysqli_query($conn, "DELETE FROM categories WHERE id = $id");
    setAlert('success', 'Deleted', 'Category removed successfully');
    header("Location: manage_categories.php");
    exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Manage Categories</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Manage Categories</h1>
            </div>
            
            <div class="form-row" style="gap: 30px; align-items: flex-start;">
                
                <!-- ADD FORM -->
                <div class="card" style="flex: 1;">
                    <h3>Add New Category</h3>
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                        <div class="form-group">
                            <label>Category Name</label>
                            <input type="text" name="name" class="form-control" placeholder="e.g. Science Fiction" required>
                        </div>
                        <button type="submit" name="add_cat" class="btn btn-primary">Add Category</button>
                    </form>
                </div>

                <!-- LIST / DELETE -->
                <div class="card" style="flex: 1;">
                    <h3>Existing Categories</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php 
                            $cats = mysqli_query($conn, "SELECT * FROM categories ORDER BY name ASC");
                            if(mysqli_num_rows($cats) > 0):
                                while($c = mysqli_fetch_assoc($cats)): 
                            ?>
                            <tr>
                                <td><?= htmlspecialchars($c['name']) ?></td>
                                <td>
                                    <a href="manage_categories.php?delete=<?= $c['id'] ?>" 
                                       class="btn btn-danger" 
                                       style="padding: 5px 10px; font-size: 12px;"
                                       onclick="return confirm('Are you sure? This will remove the category from the dropdown list.')">
                                       <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            <?php endwhile; else: ?>
                                <tr><td colspan="2">No categories found. Add one!</td></tr>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="includes/header.php">
<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Logic to check if we are in a subfolder or root
$dir_level = dirname($_SERVER['PHP_SELF']);
$base_dir = basename($dir_level);
$path = "";

// If inside admin/member/auth, go back one step
if ($base_dir === 'admin' || $base_dir === 'member' || $base_dir === 'auth') {
    $path = "../";
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo isset($page_title) ? $page_title . ' - ' : ''; ?>Library System</title>
    
    <!-- Link to the ONE Master CSS File -->
    <link rel="stylesheet" href="<?php echo $path; ?>assets/css/style.css">
    
    <!-- FontAwesome (Keep this online or download locally if needed) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="<?php echo $path; ?>index.php" class="nav-brand">
                <i class="fas fa-book-reader"></i> LMS
            </a>
            <ul class="nav-menu">
                <li><a href="<?php echo $path; ?>index.php">Home</a></li>
                
                <?php if(isset($_SESSION['user_id'])): ?>
                    <?php if($_SESSION['role'] == 'admin'): ?>
                        <li><a href="<?php echo $path; ?>admin/admin_dashboard.php">Dashboard</a></li>
                    <?php else: ?>
                        <li><a href="<?php echo $path; ?>member/dashboard.php">My Dashboard</a></li>
                        <li><a href="<?php echo $path; ?>member/books.php">Books</a></li>
                    <?php endif; ?>
                    
                    <li><a href="<?php echo $path; ?>auth/logout.php" class="btn btn-danger" style="padding: 5px 15px;">Logout</a></li>
                
                <?php else: ?>
                    <li><a href="<?php echo $path; ?>auth/login.php">Login</a></li>
                    <li><a href="<?php echo $path; ?>auth/register.php" class="btn btn-primary" style="padding: 5px 15px; color: white;">Register</a></li>
                <?php endif; ?>
            </ul>
        </div>
    </nav>
</file>

<file path="member/member_sidebar.php">
<?php if(!isset($_SESSION['user_id']) || $_SESSION['role'] != 'member') {
    header("Location: ../auth/login.php");
    exit;
} ?>
<div class="sidebar">
    <div class="sidebar-header">
        <h3><i class="fas fa-book"></i> <span>Library Member</span></h3>
    </div>
    <div class="user-info">
        <div class="user-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="user-name"><?php echo htmlspecialchars($_SESSION['full_name']); ?></div>
        <div class="user-role">Student</div>
    </div>
    <div class="sidebar-menu">
        <a href="dashboard.php" class="menu-item <?php echo basename($_SERVER['PHP_SELF']) == 'dashboard.php' ? 'active' : ''; ?>">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
        </a>
        <a href="books.php" class="menu-item <?php echo basename($_SERVER['PHP_SELF']) == 'books.php' ? 'active' : ''; ?>">
            <i class="fas fa-book-open"></i>
            <span>Browse Books</span>
        </a>
        <a href="issued_books.php" class="menu-item <?php echo basename($_SERVER['PHP_SELF']) == 'issued_books.php' ? 'active' : ''; ?>">
            <i class="fas fa-book-reader"></i>
            <span>My Books</span>
        </a>
        <a href="my_requests.php" class="menu-item <?php echo basename($_SERVER['PHP_SELF']) == 'my_requests.php' ? 'active' : ''; ?>">
            <i class="fas fa-envelope-open-text"></i>
            <span>My Requests</span>
        </a>
        <a href="profile.php" class="menu-item <?php echo basename($_SERVER['PHP_SELF']) == 'profile.php' ? 'active' : ''; ?>">
            <i class="fas fa-user"></i>
            <span>My Profile</span>
        </a>
        <a href="browse_categories.php" class="menu-item <?php echo basename($_SERVER['PHP_SELF']) == 'browse_categories.php' ? 'active' : ''; ?>">
       <i class="fas fa-th-large"></i>
       <span>Categories</span>
       </a>
        <a href="../auth/logout.php" class="menu-item" style="margin-top: 20px; color: #e74c3c;">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </a>
    </div>
</div>
</file>

<file path="member/view_book.php">
<?php
require_once '../config/db.php';
requireMember();

if (!isset($_GET['id'])) {
    header("Location: books.php");
    exit;
}

$book_id = (int)$_GET['id'];
$user_id = $_SESSION['user_id'];

// 1. Fetch Book Details
$sql = "SELECT * FROM books WHERE id = ?";
$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, "i", $book_id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$book = mysqli_fetch_assoc($result);

if (!$book) {
    echo "Book not found.";
    exit;
}

// 2. Check if the current user has this book issued
$status_sql = "SELECT * FROM issued_books WHERE user_id = ? AND book_id = ? AND status = 'issued'";
$stmt2 = mysqli_prepare($conn, $status_sql);
mysqli_stmt_bind_param($stmt2, "ii", $user_id, $book_id);
mysqli_stmt_execute($stmt2);
$is_borrowed = mysqli_stmt_fetch($stmt2);

// 3. Check if the current user already requested this book
$req_sql = "SELECT * FROM book_requests WHERE user_id = ? AND book_id = ? AND status = 'pending'";
$stmt3 = mysqli_prepare($conn, $req_sql);
mysqli_stmt_bind_param($stmt3, "ii", $user_id, $book_id);
mysqli_stmt_execute($stmt3);
$has_pending_request = mysqli_stmt_fetch($stmt3);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($book['title']) ?> - Details</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="admin-container">
    <?php include 'member_sidebar.php'; ?>

    <div class="main-content">
        <div class="content-header">
            <a href="books.php" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to List</a>
            
            <?php if($has_pending_request): ?>
                <button class="btn btn-secondary" disabled><i class="fas fa-clock"></i> Request Pending</button>
            <?php elseif($is_borrowed): ?>
                <button class="btn btn-secondary" disabled>Currently Borrowed</button>
            <?php elseif($book['available_copies'] > 0): ?>
                <form action="request_book.php" method="POST" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                    <input type="hidden" name="book_id" value="<?= $book['id'] ?>">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-hand-paper"></i> Request this Book</button>
                </form>
            <?php else: ?>
                <button class="btn btn-secondary" disabled>Out of Stock</button>
            <?php endif; ?>
        </div>

        <div class="card" style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1 style="margin-bottom: 10px; color: var(--primary);"><?= htmlspecialchars($book['title']) ?></h1>
                    <h3 style="color: #7f8c8d; font-weight: 500;">by <?= htmlspecialchars($book['author']) ?></h3>
                </div>
                
                <!-- Availability Badge -->
                <div style="text-align: right;">
                    <?php if($book['available_copies'] > 0): ?>
                        <span class="badge badge-success" style="font-size: 14px; padding: 10px 15px;">
                            <i class="fas fa-check-circle"></i> Available
                        </span>
                    <?php else: ?>
                        <span class="badge badge-danger" style="font-size: 14px; padding: 10px 15px;">
                            <i class="fas fa-times-circle"></i> Out of Stock
                        </span>
                    <?php endif; ?>
                </div>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

            <!-- User Borrow Status Notification -->
            <?php if($is_borrowed): ?>
                <div class="alert alert-warning" style="background: #fff3cd; color: #856404; border: 1px solid #ffeeba;">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> You currently have a copy of this book borrowed. 
                    <a href="issued_books.php">Check Due Date</a>
                </div>
            <?php endif; ?>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                <!-- Left Column -->
                <div>
                    <p><strong>Category:</strong> <br> <?= htmlspecialchars($book['category']) ?></p>
                    <p style="margin-top: 15px;"><strong>ISBN:</strong> <br> <span style="font-family: monospace; background: #f8f9fa; padding: 2px 6px;"><?= htmlspecialchars($book['isbn']) ?></span></p>
                </div>

                <!-- Right Column -->
                <div>
                    <p><strong>Stock Info:</strong></p>
                    <ul style="list-style: none; padding: 0; color: #666;">
                        <li>Total Copies: <?= $book['total_copies'] ?></li>
                        <li>Currently Available: <strong><?= $book['available_copies'] ?></strong></li>
                    </ul>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 10px;">Description</h4>
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; line-height: 1.6; color: #444;">
                    <?php 
                    if (!empty($book['description'])) {
                        echo nl2br(htmlspecialchars($book['description'])); 
                    } else {
                        echo "<em>No description available for this book.</em>";
                    }
                    ?>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .badge-success { background: #d4edda; color: #155724; }
    .badge-danger { background: #f8d7da; color: #721c24; }
</style>

</body>
</html>
</file>

<file path="admin/admin_login.php">
<?php
session_start();
include('../config/db.php');

if(isset($_POST['login'])){
    $username = $_POST['username'];
    $password = $_POST['password'];

    // Fix: Query 'users' table where role is admin
    $stmt = $conn->prepare("SELECT id, username, password, full_name FROM users WHERE username=? AND role='admin'");
    $stmt->bind_param("s", $username);
    $stmt->execute();
    $result = $stmt->get_result();

    if($result->num_rows == 1){
        $row = $result->fetch_assoc();
        if(password_verify($password, $row['password']) || $password === $row['password']){
            $_SESSION['user_id'] = $row['id'];
            $_SESSION['role'] = 'admin';
            $_SESSION['full_name'] = $row['full_name'];
            header("Location: admin_dashboard.php");
            exit();
        } else {
            $error = "Invalid Password";
        }
    } else {
        $error = "Invalid Username or not a Librarian";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Librarian Login</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/login.css">
</head>
<body>
    <div class="container">
        <h2>Librarian Login</h2>
        <?php if(isset($error)) echo "<p class='error'>$error</p>"; ?>
        <form method="post">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit" name="login">Login</button>
        </form>
    </div>
</body>
</html>
</file>

<file path="admin/fines.php">
<?php
require_once '../config/db.php';
requireAdmin();

$fine_rate = 2; // NRS per day

// Handle View Toggle
$active_tab = isset($_GET['tab']) ? $_GET['tab'] : 'pending';

// 1. PENDING Fines
$pending_sql = "SELECT 
                    u.id as user_id, 
                    u.full_name, 
                    u.username, 
                    u.phone, 
                    COUNT(ib.id) as overdue_books,
                    SUM(DATEDIFF(CURDATE(), ib.due_date) * $fine_rate) as total_due
                FROM issued_books ib
                JOIN users u ON ib.user_id = u.id
                WHERE ib.status = 'issued' 
                AND ib.due_date < CURDATE()
                GROUP BY u.id
                ORDER BY total_due DESC";
$pending_res = mysqli_query($conn, $pending_sql);

$pending_data = [];
$total_pending_amount = 0;
if ($pending_res) {
    while($row = mysqli_fetch_assoc($pending_res)) {
        $pending_data[] = $row;
        $total_pending_amount += $row['total_due'];
    }
}

// 2. COLLECTED Fines
$history_sql = "SELECT ib.*, b.title, u.full_name, u.username, bc.unique_code 
                FROM issued_books ib 
                JOIN books b ON ib.book_id = b.id 
                JOIN users u ON ib.user_id = u.id 
                LEFT JOIN book_copies bc ON ib.copy_id = bc.id
                WHERE ib.status = 'returned' AND ib.fine_amount > 0
                ORDER BY ib.return_date DESC";
$history_res = mysqli_query($conn, $history_sql);

$history_data = [];
$total_collected_amount = 0;
if ($history_res) {
    while($row = mysqli_fetch_assoc($history_res)) {
        $history_data[] = $row;
        $total_collected_amount += $row['fine_amount'];
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fine Management</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .nav-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .nav-item { padding: 12px 20px; text-decoration: none; color: #555; font-weight: 600; border-bottom: 3px solid transparent; cursor: pointer; }
        .nav-item:hover { color: var(--primary); background: #f8f9fa; }
        .nav-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .stat-box { padding: 20px; border-radius: 10px; color: white; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .nrs-symbol { font-size: 0.8em; opacity: 0.9; margin-right: 2px; }
    </style>
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Fine Management</h1>
            </div>

            <div class="nav-tabs">
                <a href="?tab=pending" class="nav-item <?= $active_tab == 'pending' ? 'active' : '' ?>">
                    <i class="fas fa-clock"></i> Unpaid / Due Fines
                </a>
                <a href="?tab=collected" class="nav-item <?= $active_tab == 'collected' ? 'active' : '' ?>">
                    <i class="fas fa-check-circle"></i> Collected History
                </a>
            </div>

            <?php if ($active_tab == 'pending'): ?>
                <!-- PENDING VIEW -->
                <div class="stat-box" style="background: #e74c3c;">
                    <i class="fas fa-exclamation-circle" style="font-size: 30px;"></i>
                    <div>
                        <h2 style="margin:0;"><span class="nrs-symbol">NRS.</span> <?= number_format($total_pending_amount, 2) ?></h2>
                        <span style="opacity: 0.9;">Total Outstanding Fines</span>
                    </div>
                </div>

                <div class="card">
                    <h3>Students with Due Fines</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Contact</th>
                                    <th>Overdue Books</th>
                                    <th>Total Fine Due</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if(count($pending_data) > 0): ?>
                                    <?php foreach($pending_data as $row): ?>
                                    <tr>
                                        <td>
                                            <strong><?= htmlspecialchars($row['full_name']) ?></strong><br>
                                            <small><?= htmlspecialchars($row['username']) ?></small>
                                        </td>
                                        <td><?= htmlspecialchars($row['phone']) ?></td>
                                        <td><span class="badge badge-danger"><?= $row['overdue_books'] ?> Books</span></td>
                                        <td>
                                            <span style="color: #e74c3c; font-weight: bold; font-size: 1.1em;">
                                                <small>NRS.</small> <?= number_format($row['total_due'], 2) ?>
                                            </span>
                                        </td>
                                        <td>
                                            <a href="return_book.php" class="btn btn-primary btn-sm">Collect</a>
                                        </td>
                                    </tr>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <tr><td colspan="5" class="text-center">No pending fines!</td></tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>

            <?php else: ?>
                <!-- COLLECTED VIEW -->
                <div class="stat-box" style="background: #27ae60;">
                    <i class="fas fa-wallet" style="font-size: 30px;"></i>
                    <div>
                        <h2 style="margin:0;"><span class="nrs-symbol">NRS.</span> <?= number_format($total_collected_amount, 2) ?></h2>
                        <span style="opacity: 0.9;">Total Fines Collected</span>
                    </div>
                </div>

                <div class="card">
                    <h3>Collection History</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Returned Date</th>
                                    <th>Student</th>
                                    <th>Book</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if(count($history_data) > 0): ?>
                                    <?php foreach($history_data as $row): ?>
                                    <tr>
                                        <td><?= date('M d, Y', strtotime($row['return_date'])) ?></td>
                                        <td>
                                            <strong><?= htmlspecialchars($row['full_name']) ?></strong><br>
                                            <small><?= htmlspecialchars($row['username']) ?></small>
                                        </td>
                                        <td><?= htmlspecialchars($row['title']) ?></td>
                                        <td>
                                            <span style="color: #27ae60; font-weight: bold;">
                                                <small>NRS.</small> <?= number_format($row['fine_amount'], 2) ?>
                                            </span>
                                        </td>
                                    </tr>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <tr><td colspan="4" class="text-center">No history yet.</td></tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            <?php endif; ?>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="admin/manage_members.php">
<?php
require_once '../config/db.php';
requireAdmin();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Manage Students</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css"> <!-- Add this line -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- 1. Sidebar -->
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <!-- 2. Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1>Manage Students</h1>
                <a href="add_member.php" class="btn btn-primary"><i class="fas fa-plus"></i> Add Student</a>
            </div>
            
            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $sql = "SELECT * FROM users WHERE role = 'member' ORDER BY id DESC";
                        $result = mysqli_query($conn, $sql);
                        
                        if(mysqli_num_rows($result) > 0):
                            while($m = mysqli_fetch_assoc($result)):
                        ?>
                        <tr>
                            <td><?= htmlspecialchars($m['full_name']) ?></td>
                            <td><?= htmlspecialchars($m['username']) ?></td>
                            <td><?= htmlspecialchars($m['email']) ?></td>
                            <td><?= htmlspecialchars($m['phone']) ?></td>
                            <td>
                                <a href="edit_member.php?id=<?= $m['id'] ?>" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Edit</a>
                                <a href="generate_id.php?id=<?= $m['id'] ?>" target="_blank" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">ID Card</a>
                                <a href="delete_member.php?id=<?= $m['id'] ?>" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="return confirm('Delete this student?');">Delete</a>
                            </td>
                        </tr>
                        <?php endwhile; else: ?>
                        <tr><td colspan="5" style="text-align:center; padding: 20px;">No students found</td></tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="assets/css/admin.css">
:root {
    --primary: #4361ee;
    --primary-hover: #3a53d0;
    --secondary: #3f37c9;
    --success: #4cc9f0;
    --danger: #f72585;
    --dark: #1e1e2d;
    --light: #f8f9fa;
    --gray: #aab2bd;
    --text: #2b2d42;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
}

body {
    background-color: #f3f4f6;
    font-family: 'Inter', 'Segoe UI', sans-serif; /* Modern Font stack */
}
/* Quick Add Button Layout */
.category-input-group {
    display: flex;
    gap: 10px;
}

/* Simple Modal Styles */
.modal {
    display: none; 
    position: fixed; 
    z-index: 2000; 
    left: 0; top: 0; width: 100%; height: 100%; 
    background-color: rgba(0,0,0,0.5);
}
.modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* --- Layout --- */
.admin-container {
    display: flex;
    min-height: 100vh;
}

/* --- Modern Sidebar --- */
.sidebar {
    width: 260px;
    background: var(--dark);
    color: #fff;
    position: fixed; /* Ensures it stays on the left */
    height: 100vh;
    overflow-y: auto; /* Adds scrollbar if menu is too long */
}

.sidebar-header {
    padding: 30px 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.sidebar-header h3 {
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.5px;
}

/* Find this in assets/css/admin.css and update it */
.user-info {
    padding: 25px;
    display: flex;
    flex-direction: column; /* Stack name and role vertically */
    gap: 5px;
    background: rgba(255, 255, 255, 0.05); /* Slight highlight */
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.user-avatar {
    width: 45px;
    height: 45px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
}

.user-details h4 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 2px;
}

.user-details span {
    font-size: 12px;
    color: var(--gray);
}

.sidebar-menu {
    padding: 20px 0;
}

.menu-item {
    padding: 15px 25px;
    display: flex;
    align-items: center;
    color: var(--gray);
    text-decoration: none;
    transition: 0.3s;
    font-weight: 500;
    font-size: 15px;
}

.menu-item i {
    width: 30px;
    font-size: 18px;
}

.menu-item:hover, .menu-item.active {
    color: #fff;
    background: rgba(67, 97, 238, 0.1);
    border-right: 3px solid var(--primary);
}

/* --- Main Content --- */
.main-content {
    margin-left: 260px; /* This pushes the table to the right of the sidebar */
    padding: 30px;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 35px;
}

.content-header h1 {
    font-size: 28px;
    color: var(--text);
    font-weight: 700;
}

/* --- Stats Cards --- */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.stat-card {
    background: #fff;
    padding: 25px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #fff;
    background: var(--primary);
}

.stat-info h3 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 5px;
}

.stat-info p {
    color: #7f8c8d;
    font-size: 14px;
}

/* --- Cards & Tables --- */
.card {
    background: #fff;
    border-radius: 16px;
    padding: 30px;
    box-shadow: var(--shadow);
    border: none;
    margin-bottom: 30px;
}

.table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.table th {
    background: #f8f9fa;
    color: #7f8c8d;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
    padding: 15px 20px;
    border-bottom: 2px solid #eee;
}

.table td {
    padding: 20px;
    border-bottom: 1px solid #f1f1f1;
    color: var(--text);
    vertical-align: middle;
}

.table tr:last-child td {
    border-bottom: none;
}

/* --- Badges --- */
.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}
.badge-success { background: rgba(76, 201, 240, 0.15); color: #0096c7; }
.badge-danger { background: rgba(247, 37, 133, 0.15); color: #d00000; }
.badge-warning { background: rgba(255, 183, 3, 0.15); color: #fb8500; }

/* --- Forms & Inputs --- */
.form-control {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px 15px;
    font-size: 14px;
}
.form-control:focus {
    background: #fff;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
}

.btn {
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    letter-spacing: 0.3px;
    transition: all 0.3s;
}

.btn-primary {
    background: var(--primary);
    box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
}
/* --- Print Styling --- */
@media print {
    .sidebar, .navbar, .btn, .content-header form, .no-print {
        display: none !important;
    }
    .admin-container {
        display: block !important;
        margin: 0 !important;
    }
    .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
    .card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
    body {
        background: white;
    }
}
</file>

<file path="assets/css/style.css">
/* =========================================
   1. RESET & BASE
   ========================================= */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f6f9;
    color: #333;
    min-height: 100vh;
}

a { text-decoration: none; color: inherit; }

/* =========================================
   2. ADMIN LAYOUT (CRITICAL FOR SIDEBAR)
   ========================================= */
.admin-container {
    display: flex; /* This aligns Sidebar and Content side-by-side */
    width: 100%;
    min-height: 100vh;
}

/* Sidebar - Fixed Width, Dark Background */
.sidebar {
    width: 250px;
    background-color: #1e1e2d; /* Dark Blue */
    color: white;
    display: flex;
    flex-direction: column;
    flex-shrink: 0; /* Prevents shrinking */
    min-height: 100vh;
}

.sidebar-header {
    padding: 20px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sidebar-header h3 { font-size: 18px; margin: 0; color: #ecf0f1; }

.user-info {
    padding: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sidebar-menu {
    padding: 10px 0;
    flex-grow: 1;
}

/* Sidebar Links */
.menu-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: #bdc3c7;
    font-size: 15px;
    transition: 0.3s;
    border-left: 4px solid transparent;
}

.menu-item i { margin-right: 15px; width: 20px; text-align: center; }

.menu-item:hover, .menu-item.active {
    background-color: #34495e;
    color: #fff;
    border-left-color: #3498db; /* Blue accent */
}

/* Main Content - Takes remaining space */
.main-content {
    flex-grow: 1;
    padding: 30px;
    background: #f4f6f9;
    overflow-y: auto;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.content-header h1 { font-size: 24px; color: #2c3e50; }

/* =========================================
   3. CARDS & FORMS
   ========================================= */
.card {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}

.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    border-color: #3498db;
    outline: none;
}

.form-row {
    display: flex;
    gap: 20px;
}

/* =========================================
   4. BUTTONS & TABLES
   ========================================= */
.btn {
    display: inline-block;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
}

.btn-primary { background: #3498db; color: white; }
.btn-danger { background: #e74c3c; color: white; }
.btn-secondary { background: #95a5a6; color: white; }
.btn-success { background: #2ecc71; color: white; }

.table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.table th { background: #ecf0f1; padding: 12px; text-align: left; font-weight: 700; color: #2c3e50; border-bottom: 2px solid #bdc3c7; }
.table td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }

/* =========================================
   5. ALERTS & BADGES
   ========================================= */
.custom-alert {
    position: fixed; top: 20px; right: 20px;
    background: white; padding: 15px 20px;
    border-radius: 5px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    border-left: 5px solid #333; z-index: 9999;
    transform: translateX(150%); transition: 0.3s ease-out;
}
.custom-alert.show { transform: translateX(0); }
.custom-alert.success { border-left-color: #2ecc71; }
.custom-alert.error { border-left-color: #e74c3c; }

.badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
.badge-success { background: #d4edda; color: #155724; }
.badge-danger { background: #f8d7da; color: #721c24; }
.badge-warning { background: #fff3cd; color: #856404; }

/* =========================================
   6. PUBLIC NAVBAR (For Index.php)
   ========================================= */
.navbar { background: white; padding: 15px 0; border-bottom: 1px solid #eee; }
.navbar .container { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
.nav-menu { list-style: none; display: flex; gap: 20px; }
</file>

<file path="auth/register.php">
<?php
require_once '../config/db.php';
require_once '../config/validation.php';

$error = '';
$success = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Sanitize
    $username    = Validation::sanitize($_POST['username']);
    $first_name  = Validation::sanitize($_POST['first_name']);
    $last_name   = Validation::sanitize($_POST['last_name']);
    $email       = Validation::sanitize($_POST['email']);
    $phone       = Validation::sanitize($_POST['phone'] ?? '');
    $password    = $_POST['password'];
    $confirm_pw  = $_POST['confirm_password'];

    $full_name = trim("$first_name $last_name");

    // Check duplicates
    $stmt = mysqli_prepare($conn, "SELECT id FROM users WHERE email = ? OR username = ?");
    mysqli_stmt_bind_param($stmt, "ss", $email, $username);
    mysqli_stmt_execute($stmt);
    mysqli_stmt_store_result($stmt);

    if (mysqli_stmt_num_rows($stmt) > 0) {
        $error = "Username or Email already exists.";
    } elseif ($password !== $confirm_pw) {
        $error = "Passwords do not match.";
    } else {
        $hashed = password_hash($password, PASSWORD_DEFAULT);
        $insert = mysqli_prepare($conn, "INSERT INTO users (username, full_name, email, phone, password, role) VALUES (?, ?, ?, ?, ?, 'member')");
        mysqli_stmt_bind_param($insert, "sssss", $username, $full_name, $email, $phone, $hashed);
        
        if (mysqli_stmt_execute($insert)) {
            $success = "Registration successful! <a href='login.php'>Login here</a>";
        } else {
            $error = "Error: " . mysqli_error($conn);
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Register</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/auth.css">
</head>
<body>
<div class="auth-container">
    <div class="auth-box">
        <h2>Create Account</h2>
        <?php if ($error): ?><div class="alert alert-error"><?= $error ?></div><?php endif; ?>
        <?php if ($success): ?><div class="alert alert-success"><?= $success ?></div><?php endif; ?>

        <form method="POST" class="auth-form">
            <div class="form-group">
                <label>Username *</label>
                <!-- Regex: Letters, Numbers, Underscore. 3-20 chars. -->
                <input type="text" name="username" class="form-control" 
                       pattern="[a-zA-Z0-9_]{3,20}" 
                       title="Username must be 3-20 characters long and contain only letters, numbers, and underscores."
                       required>
            </div>

            <div class="form-row" style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>First Name *</label>
                    <!-- Regex: Letters only -->
                    <input type="text" name="first_name" class="form-control" 
                           pattern="[a-zA-Z\s]+" 
                           title="First Name must contain letters only."
                           required>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Last Name *</label>
                    <input type="text" name="last_name" class="form-control" 
                           pattern="[a-zA-Z\s]+" 
                           title="Last Name must contain letters only."
                           required>
                </div>
            </div>

            <div class="form-group">
                <label>Email *</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Phone</label>
                <!-- Regex: Exactly 10 digits -->
                <input type="text" name="phone" class="form-control" 
                       pattern="[0-9]{10}" 
                       title="Please enter a valid 10-digit phone number."
                       required>
            </div>

            <div class="form-row" style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>Password *</label>
                    <!-- Regex: Min 6 chars -->
                    <input type="password" name="password" class="form-control" 
                           pattern=".{6,}" 
                           title="Password must be at least 6 characters long."
                           required>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Confirm *</label>
                    <input type="password" name="confirm_password" class="form-control" required>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Register</button>
            <div class="auth-footer">
                Already have an account? <a href="login.php">Login</a>
            </div>
        </form>
    </div>
</div>
</body>
</html>
</file>

<file path="config/db.php">
<?php
if (session_status() === PHP_SESSION_NONE) session_start();
require_once __DIR__ . '/functions.php';

$conn = mysqli_connect("localhost", "root", "", "library_db");

if (!$conn) {
    // Hide error from user for security
    error_log("Connection failed: " . mysqli_connect_error()); 
    die("System currently unavailable.");
}

function isLoggedIn() { return !empty($_SESSION['user_id']); }
function isAdmin() { return isset($_SESSION['role']) && $_SESSION['role'] === 'admin'; }
function isMember() { return isset($_SESSION['role']) && $_SESSION['role'] === 'member'; }

function requireAdmin() {
    if (!isAdmin()) {
        header("Location: ../auth/login.php");
        exit();
    }
}
function requireMember() {
    if (!isMember()) {
        header("Location: ../auth/login.php");
        exit();
    }
}
?>
</file>

<file path="config/functions.php">
<?php
// CSRF Security
function csrf_token() {
    if (session_status() === PHP_SESSION_NONE) session_start();
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

function verify_csrf() {
    if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        die("Security Validation Failed. Please go back and refresh.");
    }
}

// Set Alert for Custom Toast
function setAlert($type, $title, $message) {
    if (session_status() === PHP_SESSION_NONE) session_start();
    $_SESSION['alert'] = [
        'type' => $type, 
        'title' => $title,
        'message' => $message
    ];
}

// THE FIX FOR THE PHOTO HOLDER
function getBookCover($img) {
    // 1. Detect the project folder name dynamically
    $script_name = $_SERVER['SCRIPT_NAME']; 
    $parts = explode('/', trim($script_name, '/'));
    $project_folder = $parts[0]; 

    // 2. Browser path (for the <img> src)
    $browser_path = "/" . $project_folder . "/assets/uploads/" . $img;

    // 3. Physical path (for PHP to check if file exists)
    $server_path = $_SERVER['DOCUMENT_ROOT'] . "/" . $project_folder . "/assets/uploads/" . $img;

    // 4. Check if image exists and is not empty
    if (!empty($img) && $img !== 'default.png' && file_exists($server_path)) {
        return $browser_path;
    }
    
    // Fallback to a high-quality placeholder if image is missing
    return "https://via.placeholder.com/300x400?text=No+Cover+Found";
}
?>
</file>

<file path="index.php">
<?php
require_once 'config/db.php';
$page_title = "Home";
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 100px 0; text-align: center; }
        .hero h1 { font-size: 48px; margin-bottom: 20px; }
        .hero p { font-size: 20px; margin-bottom: 30px; max-width: 700px; margin-left: auto; margin-right: auto; }
        .features { padding: 80px 0; background: #f8f9fa; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 50px; }
        .feature-card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; }
        .feature-card:hover { transform: translateY(-10px); }
        .feature-icon { font-size: 48px; color: #667eea; margin-bottom: 20px; }
        .stats { background: #2c3e50; color: white; padding: 60px 0; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; text-align: center; }
        .stat-number { font-size: 36px; font-weight: bold; color: #3498db; }
        .cta { padding: 80px 0; text-align: center; }
    </style>
</head>
<body>
    <?php include 'includes/header.php'; ?>
    
    <section class="hero">
        <div class="container">
            <h1>Welcome to Our Library</h1>
            <p>Explore thousands of books, manage your reading, and join our community of readers. Perfect for students and book lovers.</p>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <?php if(isset($_SESSION['user_id'])): ?>
                    <?php if($_SESSION['role'] == 'admin'): ?>
                        <a href="admin/admin_dashboard.php" class="btn btn-primary" style="padding: 15px 30px; font-size: 18px;">
                            Go to Librarian Panel
                        </a>
                    <?php else: ?>
                        <a href="member/dashboard.php" class="btn btn-primary" style="padding: 15px 30px; font-size: 18px;">
                            Go to My Account
                        </a>
                    <?php endif; ?>
                <?php else: ?>
                    <a href="auth/register.php" class="btn btn-primary" style="padding: 15px 30px; font-size: 18px;">
                        Join Now
                    </a>
                    <a href="member/books.php" class="btn" style="padding: 15px 30px; font-size: 18px; background: white; color: #667eea;">
                        Browse Books
                    </a>
                <?php endif; ?>
            </div>
        </div>
    </section>
    
    <section class="features">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 50px; color: #2c3e50;">Features</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3>Book Management</h3>
                    <p>Add, edit, and manage books in the library collection with easy CRUD operations.</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <h3>Member Management</h3>
                    <p>Manage student accounts, track borrowing history, and monitor library usage.</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <h3>Book Issuing System</h3>
                    <p>Simple book issuing and returning system with due date tracking.</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="stats">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 50px;">Library Statistics</h2>
            <div class="stat-grid">
                <?php
                // Get statistics
                $total_books = mysqli_query($conn, "SELECT COUNT(*) as count FROM books")->fetch_assoc()['count'];
                $total_members = mysqli_query($conn, "SELECT COUNT(*) as count FROM users WHERE role='member'")->fetch_assoc()['count'];
                $issued_books = mysqli_query($conn, "SELECT COUNT(*) as count FROM issued_books WHERE status='issued'")->fetch_assoc()['count'];
                $available_books = mysqli_query($conn, "SELECT SUM(available_copies) as total FROM books")->fetch_assoc()['total'];
                ?>
                <div>
                    <div class="stat-number"><?php echo $total_books; ?></div>
                    <p>Total Books</p>
                </div>
                <div>
                    <div class="stat-number"><?php echo $total_members; ?></div>
                    <p>Registered Students</p>
                </div>
                <div>
                    <div class="stat-number"><?php echo $issued_books; ?></div>
                    <p>Books Issued</p>
                </div>
                <div>
                    <div class="stat-number"><?php echo $available_books; ?></div>
                    <p>Available Books</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="cta">
        <div class="container">
            <h2 style="color: #2c3e50; margin-bottom: 30px;">Ready to Start?</h2>
            <p style="font-size: 18px; color: #666; margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto;">
                Join our library community today and access thousands of books. Whether you're a student or a librarian, we have the tools you need.
            </p>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <?php if(!isset($_SESSION['user_id'])): ?>
                    <a href="auth/register.php" class="btn btn-primary" style="padding: 15px 40px; font-size: 18px;">
                        <i class="fas fa-user-plus"></i> Sign Up Free
                    </a>
                    <a href="auth/login.php" class="btn" style="padding: 15px 40px; font-size: 18px; background: #2c3e50; color: white;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                <?php else: ?>
                    <a href="member/books.php" class="btn btn-primary" style="padding: 15px 40px; font-size: 18px;">
                        <i class="fas fa-book-open"></i> Browse Books
                    </a>
                <?php endif; ?>
            </div>
        </div>
    </section>
    
    <?php include 'includes/footer.php'; ?>
    
    <script src="assets/js/validation.js"></script>
</body>
</html>
</file>

<file path="admin/edit_book.php">
<?php
require_once '../config/db.php';
requireAdmin();

if (!isset($_GET['id'])) { header("Location: manage_book.php"); exit; }
$id = (int)$_GET['id'];

$book_q = mysqli_query($conn, "SELECT * FROM books WHERE id = $id");
$book = mysqli_fetch_assoc($book_q);

if (!$book) { setAlert('error', 'Not Found', 'Book not found'); header("Location: manage_book.php"); exit; }

$cat_query = mysqli_query($conn, "SELECT name FROM categories ORDER BY name ASC");

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    verify_csrf();
    $title = $_POST['title'];
    $author = $_POST['author'];
    $isbn = $_POST['isbn'];
    $cat = $_POST['category'];
    $total = (int)$_POST['total_copies'];

    $issued_count = $book['total_copies'] - $book['available_copies'];
    $new_available = $total - $issued_count;

    if ($new_available < 0) {
        setAlert('error', 'Error', "Cannot reduce copies below issued amount ($issued_count).");
    } else {
        $cover_sql_part = "";
        if(isset($_FILES['cover']) && $_FILES['cover']['error'] == 0) {
            $ext = pathinfo($_FILES['cover']['name'], PATHINFO_EXTENSION);
            $new_name = uniqid() . "." . $ext;
            if(move_uploaded_file($_FILES['cover']['tmp_name'], "../assets/uploads/" . $new_name)) {
                $cover_sql_part = ", cover_image = '$new_name'";
            }
        }
        $sql = "UPDATE books SET title=?, author=?, isbn=?, category=?, total_copies=?, available_copies=? $cover_sql_part WHERE id=?";
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, "ssssiii", $title, $author, $isbn, $cat, $total, $new_available, $id);
        if (mysqli_stmt_execute($stmt)) {
            setAlert('success', 'Updated', 'Book updated');
            header("Location: manage_book.php");
            exit;
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Edit Book</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .category-group { display: flex; gap: 10px; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 300px; }
    </style>
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        <div class="main-content">
            <div class="content-header"><h1>Edit Book</h1></div>
            <div class="card">
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                    <div class="form-group"><label>Title</label><input type="text" name="title" class="form-control" value="<?= htmlspecialchars($book['title']) ?>" required></div>
                    <div class="form-row" style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex:1"><label>Author</label><input type="text" name="author" class="form-control" value="<?= htmlspecialchars($book['author']) ?>" required></div>
                        <div class="form-group" style="flex:1"><label>ISBN</label><input type="text" name="isbn" class="form-control" value="<?= htmlspecialchars($book['isbn']) ?>" required></div>
                    </div>
                    <div class="form-row" style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex:1">
                            <label>Category</label>
                            <div class="category-group">
                                <select name="category" id="category_dropdown" class="form-control" required>
                                    <?php while($c = mysqli_fetch_assoc($cat_query)): ?>
                                        <option value="<?= htmlspecialchars($c['name']) ?>" <?= ($c['name'] == $book['category']) ? 'selected' : '' ?>>
                                            <?= htmlspecialchars($c['name']) ?>
                                        </option>
                                    <?php endwhile; ?>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="openModal()">+</button>
                            </div>
                        </div>
                        <div class="form-group" style="flex:1"><label>Total Copies</label><input type="number" name="total_copies" class="form-control" value="<?= $book['total_copies'] ?>" required></div>
                    </div>
                    <div class="form-group"><label>Cover Image</label><input type="file" name="cover" class="form-control"></div>
                    <button class="btn btn-primary">Update Book</button>
                    <a href="manage_book.php" class="btn btn-danger">Cancel</a>
                </form>
            </div>
        </div>
    </div>

    <div id="catModal" class="modal">
        <div class="modal-content">
            <h3>Add Category</h3>
            <input type="text" id="new_cat_name" class="form-control" placeholder="Name" style="margin: 15px 0;">
            <div style="display:flex; gap:10px;">
                <button type="button" class="btn btn-primary" onclick="submitCategory()">Add</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <?php include '../includes/footer.php'; ?>
    <script>
        function openModal() { document.getElementById('catModal').style.display = 'block'; }
        function closeModal() { document.getElementById('catModal').style.display = 'none'; }
        function submitCategory() {
            const name = document.getElementById('new_cat_name').value;
            if(!name) return;
            const fd = new FormData(); fd.append('name', name);
            fetch('ajax_add_category.php', { method: 'POST', body: fd })
            .then(res => res.json()).then(data => {
                if(data.status === 'success'){
                    const opt = new Option(data.name, data.name);
                    const sel = document.getElementById('category_dropdown');
                    sel.add(opt); sel.value = data.name;
                    closeModal();
                } else { alert(data.message); }
            });
        }
    </script>
</body>
</html>
</file>

<file path="admin/return_book.php">
<?php
require_once '../config/db.php';
requireAdmin();

$error = '';
$success = '';

if(isset($_GET['return_id'])) {
    $return_id = (int)$_GET['return_id'];
    mysqli_begin_transaction($conn);
    try {
        $get_sql = "SELECT book_id, copy_id, due_date FROM issued_books WHERE id = ? AND status = 'issued'";
        $get_stmt = mysqli_prepare($conn, $get_sql);
        mysqli_stmt_bind_param($get_stmt, "i", $return_id);
        mysqli_stmt_execute($get_stmt);
        $issue_data = mysqli_fetch_assoc(mysqli_stmt_get_result($get_stmt));
        mysqli_stmt_close($get_stmt);
        
        if($issue_data) {
            $book_id = $issue_data['book_id'];
            $copy_id = $issue_data['copy_id'];
            
            $due_date = new DateTime($issue_data['due_date']);
            $today = new DateTime();
            $fine_amount = 0;

            if ($today > $due_date) {
                $days_overdue = $today->diff($due_date)->days;
                $fine_amount = $days_overdue * 2; 
            }

            $update_issue = "UPDATE issued_books SET status = 'returned', return_date = CURDATE(), fine_amount = ? WHERE id = ?";
            $stmt1 = mysqli_prepare($conn, $update_issue);
            mysqli_stmt_bind_param($stmt1, "di", $fine_amount, $return_id);
            mysqli_stmt_execute($stmt1);
            
            if($copy_id) {
                $update_copy = "UPDATE book_copies SET status = 'available' WHERE id = ?";
                $stmt2 = mysqli_prepare($conn, $update_copy);
                mysqli_stmt_bind_param($stmt2, "i", $copy_id);
                mysqli_stmt_execute($stmt2);
            }

            $update_book = "UPDATE books SET available_copies = available_copies + 1 WHERE id = ?";
            $stmt3 = mysqli_prepare($conn, $update_book);
            mysqli_stmt_bind_param($stmt3, "i", $book_id);
            mysqli_stmt_execute($stmt3);
            
            mysqli_commit($conn);
            $msg = "Book returned successfully!";
            if($fine_amount > 0) {
                $msg .= " <strong>Fine Collected: NRS. " . number_format($fine_amount, 2) . "</strong>";
            }
            setAlert('success', 'Returned', $msg);
            header("Location: return_book.php");
            exit;

        } else { throw new Exception("Invalid record."); }
    } catch(Exception $e) {
        mysqli_rollback($conn);
        setAlert('error', 'Error', $e->getMessage());
    }
}

$sql = "SELECT ib.*, b.title, u.full_name, u.username, bc.unique_code 
        FROM issued_books ib 
        JOIN books b ON ib.book_id = b.id 
        JOIN users u ON ib.user_id = u.id 
        LEFT JOIN book_copies bc ON ib.copy_id = bc.id
        WHERE ib.status = 'issued' 
        ORDER BY ib.due_date ASC";
$result = mysqli_query($conn, $sql);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Return Book</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Return Book</h1>
            </div>
            
            <div class="card">
                <h3>Currently Issued Books</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Book Details</th>
                                <th>Due Date</th>
                                <th>Fine (Pending)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if(mysqli_num_rows($result) > 0): ?>
                                <?php while($row = mysqli_fetch_assoc($result)): 
                                    $due_date = new DateTime($row['due_date']);
                                    $today = new DateTime();
                                    $is_overdue = $today > $due_date;
                                    $pending_fine = $is_overdue ? ($today->diff($due_date)->days * 2) : 0;
                                ?>
                                <tr style="<?= $is_overdue ? 'background-color: #fff5f5;' : '' ?>">
                                    <td>
                                        <strong><?= htmlspecialchars($row['full_name']) ?></strong><br>
                                        <small><?= htmlspecialchars($row['username']) ?></small>
                                    </td>
                                    <td>
                                        <?= htmlspecialchars($row['title']) ?><br>
                                        <small class="badge" style="background:#e9ecef; color:#333; font-family:monospace;"><?= $row['unique_code'] ?></small>
                                    </td>
                                    <td>
                                        <?= date('M d, Y', strtotime($row['due_date'])) ?><br>
                                        <?php if($is_overdue): ?>
                                            <span style="color:red; font-size:12px; font-weight:bold;">Overdue</span>
                                        <?php else: ?>
                                            <span style="color:green; font-size:12px;">Active</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <?php if($pending_fine > 0): ?>
                                            <span class="badge badge-danger" style="font-size:14px;">NRS. <?= number_format($pending_fine, 2) ?></span>
                                        <?php else: ?>
                                            <span style="color: #999;">-</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <a href="?return_id=<?php echo $row['id']; ?>" class="btn btn-primary btn-sm"
                                           onclick="return confirm('Confirm Return?\n\nPending Fine: NRS. <?= number_format($pending_fine, 2) ?>')">
                                           Return Book
                                        </a>
                                    </td>
                                </tr>
                                <?php endwhile; ?>
                            <?php else: ?>
                                <tr><td colspan="5" class="text-center">No issued books found</td></tr>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="member/issued_books.php">
<?php
require_once '../config/db.php';
requireMember();

$user_id = $_SESSION['user_id'];

// 1. Currently Issued
$sql_active = "SELECT ib.*, b.title, b.author, bc.unique_code 
               FROM issued_books ib 
               JOIN books b ON ib.book_id = b.id 
               LEFT JOIN book_copies bc ON ib.copy_id = bc.id
               WHERE ib.user_id = ? AND ib.status = 'issued' 
               ORDER BY ib.due_date ASC";
$stmt = mysqli_prepare($conn, $sql_active);
mysqli_stmt_bind_param($stmt, "i", $user_id);
mysqli_stmt_execute($stmt);
$res_active = mysqli_stmt_get_result($stmt);

// 2. History
$sql_history = "SELECT ib.*, b.title, b.author, bc.unique_code 
                FROM issued_books ib 
                JOIN books b ON ib.book_id = b.id 
                LEFT JOIN book_copies bc ON ib.copy_id = bc.id
                WHERE ib.user_id = ? AND ib.status = 'returned' 
                ORDER BY ib.return_date DESC LIMIT 10";
$stmt2 = mysqli_prepare($conn, $sql_history);
mysqli_stmt_bind_param($stmt2, "i", $user_id);
mysqli_stmt_execute($stmt2);
$res_history = mysqli_stmt_get_result($stmt2);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Books</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="admin-container">
    <?php include 'member_sidebar.php'; ?>

    <div class="main-content">
        <div class="content-header">
            <h1>My Books</h1>
        </div>

        <!-- Currently Reading -->
        <div class="card">
            <h3>Currently Reading</h3>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Code</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Est. Fine</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?php if (mysqli_num_rows($res_active) > 0): ?>
                        <?php while ($row = mysqli_fetch_assoc($res_active)): 
                            $due_date = new DateTime($row['due_date']);
                            $today = new DateTime();
                            $is_overdue = $today > $due_date;
                            $est_fine = 0;
                            if($is_overdue) {
                                $days = $today->diff($due_date)->days;
                                $est_fine = $days * 2;
                            }
                        ?>
                        <tr style="<?= $is_overdue ? 'background-color: #fff5f5;' : '' ?>">
                            <td style="font-weight:600"><?= htmlspecialchars($row['title']) ?></td>
                            <td><span style="background: #e1f5fe; padding: 2px 6px; border-radius: 4px; font-family: monospace;"><?= htmlspecialchars($row['unique_code'] ?? 'N/A') ?></span></td>
                            <td><?= date('M d, Y', strtotime($row['due_date'])) ?></td>
                            <td>
                                <?php if ($is_overdue): ?>
                                    <span style="color: red; font-weight: bold;">Overdue</span>
                                <?php else: ?>
                                    <span style="color: green;">Active</span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php if ($est_fine > 0): ?>
                                    <span style="color: red; font-weight: bold;">NRS <?= $est_fine ?></span>
                                <?php else: ?>
                                    -
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endwhile; ?>
                    <?php else: ?>
                        <tr><td colspan="5" class="text-center">No books currently issued.</td></tr>
                    <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- History -->
        <div class="card" style="margin-top: 30px;">
            <h3>History</h3>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Returned On</th>
                            <th>Fine Paid</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?php while ($row = mysqli_fetch_assoc($res_history)): ?>
                        <tr>
                            <td><?= htmlspecialchars($row['title']) ?></td>
                            <td><?= date('M d, Y', strtotime($row['return_date'])) ?></td>
                            <td>
                                <?php if ($row['fine_amount'] > 0): ?>
                                    <span class="badge badge-danger">NRS <?= $row['fine_amount'] ?></span>
                                <?php else: ?>
                                    <span style="color: #999;">0</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>
</html>
</file>

<file path="admin/admin_dashboard.php">
<?php
require_once '../config/db.php';
requireAdmin();

// --- 1. EXISTING COUNTERS ---
$books_count = mysqli_fetch_assoc(mysqli_query($conn, "SELECT COUNT(*) as c FROM books"))['c'];
$students_count = mysqli_fetch_assoc(mysqli_query($conn, "SELECT COUNT(*) as c FROM users WHERE role='member'"))['c'];
$issued_count = mysqli_fetch_assoc(mysqli_query($conn, "SELECT COUNT(*) as c FROM issued_books WHERE status='issued'"))['c'];
$overdue_count = mysqli_fetch_assoc(mysqli_query($conn, "SELECT COUNT(*) as c FROM issued_books WHERE status='issued' AND due_date < CURDATE()"))['c'];

// --- 2. NEW: DATA FOR CHARTS ---

// Chart A: Top 5 Most Issued Books
$top_books_labels = [];
$top_books_data = [];
$sql_top = "SELECT b.title, COUNT(ib.id) as issue_count 
            FROM issued_books ib 
            JOIN books b ON ib.book_id = b.id 
            GROUP BY ib.book_id 
            ORDER BY issue_count DESC LIMIT 5";
$res_top = mysqli_query($conn, $sql_top);
while($row = mysqli_fetch_assoc($res_top)) {
    // Shorten title if it's too long (e.g., "Harry Potter..." becomes "Harry P...")
    $title = strlen($row['title']) > 15 ? substr($row['title'], 0, 15) . '...' : $row['title'];
    $top_books_labels[] = $title;
    $top_books_data[] = $row['issue_count'];
}

// Chart B: Books per Category
$cat_labels = [];
$cat_data = [];
$sql_cat = "SELECT category, COUNT(*) as count FROM books GROUP BY category";
$res_cat = mysqli_query($conn, $sql_cat);
while($row = mysqli_fetch_assoc($res_cat)) {
    $cat_labels[] = $row['category'];
    $cat_data[] = $row['count'];
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Stats Grid Fix */
        .stats-grid a { text-decoration: none; color: inherit; display: block; }
        .stat-card { transition: all 0.3s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        
        /* Chart Container Styling */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2 parts width, 1 part width */
            gap: 25px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        /* Make charts responsive on mobile */
        @media (max-width: 900px) {
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <div>
                    <h1>Dashboard</h1>
                    <p style="color: #7f8c8d; margin-top: 5px;">Overview & Analytics</p>
                </div>
                <div>
                    <a href="issue_book.php" class="btn btn-primary"><i class="fas fa-plus"></i> Issue New Book</a>
                </div>
            </div>
            
            <!-- 1. Stats Grid -->
            <div class="stats-grid">
                <a href="manage_book.php">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #4361ee;"><i class="fas fa-book"></i></div>
                        <div class="stat-info">
                            <h3><?= $books_count ?></h3>
                            <p>Total Books</p>
                        </div>
                    </div>
                </a>
                
                <a href="manage_members.php">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #3f37c9;"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <h3><?= $students_count ?></h3>
                            <p>Students</p>
                        </div>
                    </div>
                </a>
                
                <a href="issue_book.php">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #4cc9f0;"><i class="fas fa-book-reader"></i></div>
                        <div class="stat-info">
                            <h3><?= $issued_count ?></h3>
                            <p>Issued Now</p>
                        </div>
                    </div>
                </a>
                
                <a href="return_book.php">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #f72585;"><i class="fas fa-clock"></i></div>
                        <div class="stat-info">
                            <h3><?= $overdue_count ?></h3>
                            <p>Overdue</p>
                        </div>
                    </div>
                </a>
            </div>

            <!-- 2. Charts Section (NEW) -->
            <div class="charts-container">
                <!-- Bar Chart: Most Popular Books -->
                <div class="chart-card">
                    <h3 style="margin-bottom: 15px; color: #444;">Most Popular Books (Top 5)</h3>
                    <canvas id="topBooksChart"></canvas>
                </div>
                
                <!-- Doughnut Chart: Categories -->
                <div class="chart-card">
                    <h3 style="margin-bottom: 15px; color: #444;">Library Composition</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <!-- 3. Recent Activity Table -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Recent Issues</h3>
                    <a href="return_book.php" style="color: var(--primary); text-decoration: none; font-size: 14px;">View All</a>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Book Title</th>
                            <th>Issued On</th>
                            <th>Due Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $recent = mysqli_query($conn, "
                            SELECT ib.*, u.full_name, b.title 
                            FROM issued_books ib
                            JOIN users u ON ib.user_id = u.id
                            JOIN books b ON ib.book_id = b.id
                            ORDER BY ib.issue_date DESC LIMIT 5
                        ");
                        if(mysqli_num_rows($recent) > 0):
                            while($row = mysqli_fetch_assoc($recent)):
                                $is_overdue = ($row['status'] == 'issued' && strtotime($row['due_date']) < time());
                        ?>
                        <tr>
                            <td style="font-weight: 500;"><?= htmlspecialchars($row['full_name']) ?></td>
                            <td><?= htmlspecialchars($row['title']) ?></td>
                            <td><?= date('M d', strtotime($row['issue_date'])) ?></td>
                            <td><?= date('M d', strtotime($row['due_date'])) ?></td>
                            <td>
                                <?php if($row['status'] == 'returned'): ?>
                                    <span class="badge badge-success">Returned</span>
                                <?php elseif($is_overdue): ?>
                                    <span class="badge badge-danger">Overdue</span>
                                <?php else: ?>
                                    <span class="badge badge-warning">Issued</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endwhile; 
                        else: ?>
                            <tr><td colspan="5" style="text-align:center;">No recent activity</td></tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>

    <!-- JAVASCRIPT FOR CHARTS -->
    <script>
        // Data from PHP
        const topBooksLabels = <?php echo json_encode($top_books_labels); ?>;
        const topBooksData = <?php echo json_encode($top_books_data); ?>;
        
        const catLabels = <?php echo json_encode($cat_labels); ?>;
        const catData = <?php echo json_encode($cat_data); ?>;

        // 1. Bar Chart Config
        const ctx1 = document.getElementById('topBooksChart').getContext('2d');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: topBooksLabels,
                datasets: [{
                    label: 'Times Issued',
                    data: topBooksData,
                    backgroundColor: '#4361ee',
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 2. Doughnut Chart Config
        const ctx2 = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: catLabels,
                datasets: [{
                    data: catData,
                    backgroundColor: [
                        '#4cc9f0', '#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4895ef'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                }
            }
        });
    </script>
</body>
</html>
</file>

<file path="database.sql">
-- 1. Create the Database
CREATE DATABASE IF NOT EXISTS library_db;
USE library_db;

-- ==========================================
-- DROP TABLES (Ordered to handle dependencies)
-- ==========================================
SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS issued_books;
DROP TABLE IF EXISTS book_copies;
DROP TABLE IF EXISTS books;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS categories;
SET FOREIGN_KEY_CHECKS = 1;

-- ==========================================
-- TABLE STRUCTURES
-- ==========================================

-- 2. Categories Table (NEW: For the dropdown and Quick Add feature)
CREATE TABLE categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. Users Table
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(15),
    role VARCHAR(20) DEFAULT 'member', -- 'admin' or 'member'
    status VARCHAR(20) DEFAULT 'active',
    reset_token_hash VARCHAR(64) DEFAULT NULL,
    reset_token_expires_at DATETIME DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. Books Table
CREATE TABLE books (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    author VARCHAR(100) NOT NULL,
    isbn VARCHAR(20) UNIQUE NOT NULL,
    category VARCHAR(100), -- Linked to categories.name
    description TEXT,
    cover_image VARCHAR(255) DEFAULT 'default.png',
    total_copies INT DEFAULT 1,
    available_copies INT DEFAULT 1,
    added_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. Book Copies Table (Tracks individual physical books)
CREATE TABLE book_copies (
    id INT AUTO_INCREMENT PRIMARY KEY,
    book_id INT NOT NULL,
    unique_code VARCHAR(50) UNIQUE NOT NULL, 
    status VARCHAR(20) DEFAULT 'available', -- 'available', 'issued', 'lost'
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 6. Issued Books Table
CREATE TABLE issued_books (
    id INT AUTO_INCREMENT PRIMARY KEY,
    book_id INT NOT NULL,
    copy_id INT NOT NULL,
    user_id INT NOT NULL,
    issue_date DATE NOT NULL,
    due_date DATE NOT NULL,
    return_date DATE DEFAULT NULL,
    status VARCHAR(20) DEFAULT 'issued', -- 'issued' or 'returned'
    fine_amount DECIMAL(8,2) DEFAULT 0.00,
    FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE,
    FOREIGN KEY (copy_id) REFERENCES book_copies(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ==========================================
-- DEFAULT / SAMPLE DATA
-- ==========================================

-- 1. Default Admin (Password: admin123)
-- Use your 'reset_admin.php' or register page to create your specific accounts
INSERT INTO users (username, password, full_name, email, role) VALUES
('admin', '$2y$10$8Wk/y/rQ6lB.0k0vMv5XEOpG9XnLwR6k/m6e2e2e2e2e2e2e2e2e2', 'Super Administrator', 'admin@library.com', 'admin');

-- 2. Default Categories
INSERT INTO categories (name) VALUES 
('Computer Science'), 
('Mathematics'), 
('Fiction'), 
('Science Fiction'), 
('Biography'), 
('History');

-- 3. Sample Book
INSERT INTO books (title, author, isbn, category, total_copies, available_copies) VALUES
('Introduction to Algorithms', 'Thomas H. Cormen', '9780262033848', 'Computer Science', 2, 2);

-- 4. Sample Book Copies
INSERT INTO book_copies (book_id, unique_code, status) VALUES
(1, '9780262033848-101-1', 'available'),
(1, '9780262033848-101-2', 'available');

-- ==========================================
-- INDEXES FOR PERFORMANCE
-- ==========================================
CREATE INDEX idx_book_isbn ON books(isbn);
CREATE INDEX idx_issue_status ON issued_books(status);
CREATE INDEX idx_copy_code ON book_copies(unique_code);
</file>

<file path="admin/issue_book.php">
<?php
require_once '../config/db.php';
requireAdmin();

// 1. Fetch Students
$members_res = mysqli_query($conn, "SELECT id, full_name, username FROM users WHERE role='member' ORDER BY full_name ASC");

// 2. Fetch Available Books
$books_res = mysqli_query($conn, "SELECT bc.id, bc.unique_code, b.title FROM book_copies bc JOIN books b ON bc.book_id = b.id WHERE bc.status='available' ORDER BY b.title ASC");

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verify_csrf();
    $copy_id = (int)$_POST['copy_id'];
    $user_id = (int)$_POST['user_id'];
    $due_date = $_POST['due_date'];

    if ($copy_id && $user_id) {
        mysqli_begin_transaction($conn);
        try {
            $book_check = mysqli_fetch_assoc(mysqli_query($conn, "SELECT book_id FROM book_copies WHERE id=$copy_id AND status='available'"));
            if ($book_check) {
                $book_id = $book_check['book_id'];
                mysqli_query($conn, "INSERT INTO issued_books (book_id, copy_id, user_id, issue_date, due_date, status) VALUES ($book_id, $copy_id, $user_id, CURDATE(), '$due_date', 'issued')");
                mysqli_query($conn, "UPDATE book_copies SET status='issued' WHERE id=$copy_id");
                mysqli_query($conn, "UPDATE books SET available_copies=available_copies-1 WHERE id=$book_id");
                mysqli_commit($conn);
                setAlert('success', 'Success', 'Book issued successfully!');
                header("Location: issue_book.php");
                exit;
            } else {
                setAlert('error', 'Error', 'Book copy not available.');
            }
        } catch (Exception $e) {
            mysqli_rollback($conn);
            setAlert('error', 'Error', 'Database error.');
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Issue Book</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css"> <!-- Add this line -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- 1. Include Sidebar -->
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <!-- 2. Main Content Area -->
        <div class="main-content">
            <div class="content-header">
                <h1>Issue Book</h1>
            </div>

            <div class="card">
                <?php if(mysqli_num_rows($books_res) == 0): ?>
                    <div style="padding:15px; background:#fff3cd; color:#856404; margin-bottom:15px; border-radius:4px;">
                        Warning: No available books found. <a href="manage_book.php">Add Books</a> or Edit Books to generate copies.
                    </div>
                <?php endif; ?>

                <form method="POST">
                    <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                    
                    <div class="form-group">
                        <label>Select Book Copy</label>
                        <select name="copy_id" class="form-control" required>
                            <option value="">-- Choose Book --</option>
                            <?php 
                            if(mysqli_num_rows($books_res) > 0) {
                                while($row = mysqli_fetch_assoc($books_res)) {
                                    echo '<option value="'.$row['id'].'">['.$row['unique_code'].'] - '.$row['title'].'</option>';
                                }
                            }
                            ?>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Select Student</label>
                        <select name="user_id" class="form-control" required>
                            <option value="">-- Choose Student --</option>
                            <?php 
                            if(mysqli_num_rows($members_res) > 0) {
                                while($row = mysqli_fetch_assoc($members_res)) {
                                    echo '<option value="'.$row['id'].'">'.$row['full_name'].' ('.$row['username'].')</option>';
                                }
                            }
                            ?>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" name="due_date" class="form-control" value="<?= date('Y-m-d', strtotime('+15 days')) ?>" required>
                    </div>

                    <button class="btn btn-primary">Issue Book</button>
                </form>
            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="member/books.php">
<?php
require_once '../config/db.php';
requireMember();

$search = $_GET['search'] ?? '';
$cat = $_GET['category'] ?? '';

$sql = "SELECT * FROM books WHERE 1=1";
if ($search) $sql .= " AND title LIKE '%$search%'";
if ($cat) $sql .= " AND category = '$cat'";

$result = mysqli_query($conn, $sql);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Browse Books</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="admin-container">
    <?php include 'member_sidebar.php'; ?>
    
    <div class="main-content">
        <div class="content-header">
            <h1>Browse Books</h1>
        </div>

        <div class="card">
            <form method="GET" style="display: flex; gap: 10px;">
                <input type="text" name="search" class="form-control" placeholder="Search..." value="<?= htmlspecialchars($search) ?>">
                <button class="btn btn-primary">Search</button>
            </form>
        </div>

        <div class="books-grid">
            <?php while($book = mysqli_fetch_assoc($result)): 
                $img = getBookCover($book['cover_image']);
            ?>
            <div class="book-card">
                <img src="<?= $img ?>" class="book-cover-img" alt="Cover">
                <div class="book-info">
                    <div class="book-title"><?= htmlspecialchars($book['title']) ?></div>
                    <div class="book-author"><?= htmlspecialchars($book['author']) ?></div>
                    
                    <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: center;">
                        <?php if($book['available_copies'] > 0): ?>
                            <span class="stock-badge in-stock">Available</span>
                        <?php else: ?>
                            <span class="stock-badge out-stock">Out of Stock</span>
                        <?php endif; ?>
                        
                        <a href="view_book.php?id=<?= $book['id'] ?>" class="btn btn-primary" style="padding: 5px 10px; font-size: 13px;">View</a>
                    </div>
                </div>
            </div>
            <?php endwhile; ?>
        </div>
    </div>
</div>
<?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="member/dashboard.php">
<?php
require_once '../config/db.php';
requireMember();

$user_id   = $_SESSION['user_id'];
$full_name = $_SESSION['full_name'] ?? 'Student';

// Initialize Counters
$issued_count = 0;
$overdue_count = 0;
$total_pending_fine = 0;

// Calculate stats
$sql_stats = "SELECT due_date FROM issued_books WHERE user_id = $user_id AND status = 'issued'";
$result_stats = mysqli_query($conn, $sql_stats);

while($row = mysqli_fetch_assoc($result_stats)) {
    $issued_count++;
    $due_date = new DateTime($row['due_date']);
    $due_date->setTime(0, 0, 0);
    $today = new DateTime();
    $today->setTime(0, 0, 0);
    
    if($today > $due_date) {
        $overdue_count++;
        $days_late = $today->diff($due_date)->days;
        $total_pending_fine += ($days_late * 2); // NRS 2 per day
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .stats-grid a { text-decoration: none; color: inherit; display: block; }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 1px solid #ddd; }
    </style>
</head>
<body>
<div class="admin-container">
    <?php include 'member_sidebar.php'; ?>

    <div class="main-content">
        <div class="content-header">
            <h1>Welcome, <?= htmlspecialchars($full_name) ?> üëã</h1>
        </div>

        <div class="stats-grid">
            <a href="issued_books.php">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db;"><i class="fas fa-book-reader"></i></div>
                    <div class="stat-info">
                        <h3><?= $issued_count ?></h3>
                        <p>Books Issued</p>
                    </div>
                </div>
            </a>
            
            <a href="issued_books.php">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e74c3c;"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="stat-info">
                        <h3><?= $overdue_count ?></h3>
                        <p>Overdue Books</p>
                    </div>
                </div>
            </a>

            <a href="issued_books.php">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f1c40f; color: #fff;">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-info">
                        <h3><small style="font-size: 14px;">NRS.</small> <?= number_format($total_pending_fine, 2) ?></h3>
                        <p>Pending Fine</p>
                    </div>
                </div>
            </a>
        </div>

        <div class="card">
            <h3>Current Readings</h3>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Book Title</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Fine</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?php
                    $query = "SELECT b.title, ib.due_date, bc.unique_code 
                              FROM issued_books ib 
                              JOIN books b ON ib.book_id = b.id 
                              LEFT JOIN book_copies bc ON ib.copy_id = bc.id
                              WHERE ib.user_id = ? AND ib.status = 'issued' 
                              ORDER BY ib.due_date ASC LIMIT 5";
                    $stmt = mysqli_prepare($conn, $query);
                    mysqli_stmt_bind_param($stmt, "i", $user_id);
                    mysqli_stmt_execute($stmt);
                    $result = mysqli_stmt_get_result($stmt);

                    if (mysqli_num_rows($result) > 0):
                        while ($r = mysqli_fetch_assoc($result)): 
                            $due = new DateTime($r['due_date']);
                            $due->setTime(0,0,0);
                            $now = new DateTime();
                            $now->setTime(0,0,0);
                            $is_overdue = $now > $due;
                            $fine = $is_overdue ? ($now->diff($due)->days * 2) : 0;
                    ?>
                        <tr>
                            <td><span style="background: #f1f3f5; padding: 3px 6px; border-radius: 4px; font-family: monospace; font-size: 12px;"><?= $r['unique_code'] ?? 'N/A' ?></span></td>
                            <td style="font-weight: 600;"><?= htmlspecialchars($r['title']) ?></td>
                            <td><?= date('M d, Y', strtotime($r['due_date'])) ?></td>
                            <td>
                                <span class="badge badge-<?= $is_overdue ? 'danger' : 'success' ?>">
                                    <?= $is_overdue ? 'Overdue' : 'Active' ?>
                                </span>
                            </td>
                            <td>
                                <?php if($fine > 0): ?>
                                    <span style="color: #e74c3c; font-weight: bold;"><small>NRS.</small> <?= $fine ?></span>
                                <?php else: ?>
                                    <span style="color: #2ecc71;">-</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endwhile; else: ?>
                        <tr><td colspan="5" class="text-center">No books issued.</td></tr>
                    <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="admin/manage_book.php">
<?php
require_once '../config/db.php';
requireAdmin();

$search = $_GET['search'] ?? '';
$category_filter = $_GET['category'] ?? '';

$sql = "SELECT * FROM books WHERE 1=1";

if($search) {
    $search = mysqli_real_escape_string($conn, $search);
    $sql .= " AND (title LIKE '%$search%' OR author LIKE '%$search%' OR isbn LIKE '%$search%')";
}
if($category_filter) {
    $cat_safe = mysqli_real_escape_string($conn, $category_filter);
    $sql .= " AND category = '$cat_safe'";
}
$sql .= " ORDER BY id DESC";
$books = mysqli_query($conn, $sql);
$cat_query = mysqli_query($conn, "SELECT name FROM categories ORDER BY name ASC");
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Manage Books</title>
    <!-- Add BOTH CSS files -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css"> <!-- THIS WAS MISSING -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        
        <div class="main-content">
            <div class="content-header">
                <h1>Manage Books</h1>
                <a href="add_book.php" class="btn btn-primary"><i class="fas fa-plus"></i> Add New Book</a>
            </div>
            
            <div class="card">
                <!-- Search -->
                <form method="GET" style="margin-bottom: 25px; display: flex; gap: 10px;">
                    <input type="text" name="search" class="form-control" placeholder="Search..." value="<?= htmlspecialchars($search) ?>">
                    <select name="category" class="form-control" style="width: 200px;">
                        <option value="">All Categories</option>
                        <?php while($c = mysqli_fetch_assoc($cat_query)): ?>
                            <option value="<?= htmlspecialchars($c['name']) ?>" <?= ($category_filter == $c['name']) ? 'selected' : '' ?>>
                                <?= htmlspecialchars($c['name']) ?>
                            </option>
                        <?php endwhile; ?>
                    </select>
                    <button class="btn btn-primary">Filter</button>
                    <?php if($search || $category_filter): ?>
                        <a href="manage_book.php" class="btn btn-secondary">Clear</a>
                    <?php endif; ?>
                </form>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Cover</th>
                            <th>ISBN</th>
                            <th>Title</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
    <?php if(mysqli_num_rows($books) > 0): ?>
        <?php while($row = mysqli_fetch_assoc($books)): 
            // Correct way to call the image
            $img_path = getBookCover($row['cover_image']);
        ?>
        <tr>
            <td>
                <div style="width: 50px; height: 70px; background: #eee; border-radius: 4px; overflow: hidden; border: 1px solid #ddd;">
                    <img src="<?= $img_path ?>" style="width: 100%; height: 100%; object-fit: cover;" alt="Cover">
                </div>
            </td>
            <td style="font-family: monospace; color: #666;"><?= $row['isbn'] ?></td>
            <td>
                <strong><?= htmlspecialchars($row['title']) ?></strong><br>
                <small><?= htmlspecialchars($row['author']) ?></small>
            </td>
            <td>
                <?php if($row['available_copies'] > 0): ?>
                    <span class="badge badge-success"><?= $row['available_copies'] ?> Available</span>
                <?php else: ?>
                    <span class="badge badge-danger">Out of Stock</span>
                <?php endif; ?>
            </td>
            <td>
                <a href="edit_book.php?id=<?= $row['id'] ?>" class="btn btn-primary" style="padding: 5px 10px;"><i class="fas fa-edit"></i></a>
                <a href="delete_book.php?id=<?= $row['id'] ?>" class="btn btn-danger" style="padding: 5px 10px;" onclick="return confirm('Delete?');"><i class="fas fa-trash"></i></a>
            </td>
        </tr>
        <?php endwhile; ?>
    <?php else: ?>
        <tr><td colspan="5" style="text-align: center;">No books found.</td></tr>
    <?php endif; ?>
</tbody>
                </table>
            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="auth/login.php">
<?php
require_once '../config/db.php';

if($_SERVER["REQUEST_METHOD"] == "POST") {
    verify_csrf();

    $username = $_POST['username'];
    $password = $_POST['password'];
    $role = $_POST['role'];
    
    $stmt = mysqli_prepare($conn, "SELECT id, password, role, full_name FROM users WHERE username = ? AND role = ?");
    mysqli_stmt_bind_param($stmt, "ss", $username, $role);
    mysqli_stmt_execute($stmt);
    $res = mysqli_stmt_get_result($stmt);
    
    if($row = mysqli_fetch_assoc($res)) {
        if(password_verify($password, $row['password'])) {
            session_regenerate_id(true);
            $_SESSION["user_id"] = $row['id'];
            $_SESSION["role"] = $row['role'];
            $_SESSION["full_name"] = $row['full_name'];
            
            setAlert('success', 'Success', 'Login successful');
            
            if($role == 'admin') header("Location: ../admin/admin_dashboard.php");
            else header("Location: ../member/dashboard.php");
            exit;
        }
    }
    setAlert('error', 'Failed', 'Invalid credentials');
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Login</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/auth.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <h2>Login</h2>
            <form class="auth-form" method="POST">
                <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" class="form-control" 
                           pattern="[a-zA-Z0-9_]{3,20}" 
                           title="Your username"
                           required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="role" class="form-control">
                        <option value="member">Student</option>
                        <option value="admin">Librarian</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <a href="register.php">Create Account</a>
            </div>
        </div>
    </div>
    <?php include '../includes/footer.php'; ?>
</body>
</html>
</file>

<file path="includes/admin_sidebar.php">
<div class="sidebar">
    <div class="sidebar-header">
        <h3><i class="fas fa-book-reader"></i> LMS Librarian</h3>
    </div>
    
    <div class="user-info">
        <div class="user-details">
            <h4 style="margin:0; font-size:16px; color: white;">
                <?php echo htmlspecialchars($_SESSION['full_name'] ?? 'Librarian'); ?>
            </h4>
            <span style="font-size:12px; color:#bdc3c7;">Librarian</span>
        </div>
    </div>

    <div class="sidebar-menu">
        <a href="admin_dashboard.php" class="menu-item">
            <i class="fas fa-home"></i> <span>Dashboard</span>
        </a>
        <a href="manage_book.php" class="menu-item">
            <i class="fas fa-book"></i> <span>Manage Books</span>
        </a>
        <a href="manage_members.php" class="menu-item">
            <i class="fas fa-users"></i> <span>Manage Students</span>
        </a>
        <a href="manage_requests.php" class="menu-item">
            <i class="fas fa-envelope-open-text"></i> <span>Book Requests</span>
        </a>
        <a href="issue_book.php" class="menu-item">
            <i class="fas fa-hand-holding"></i> <span>Issue Book</span>
        </a>
        <a href="return_book.php" class="menu-item">
            <i class="fas fa-undo"></i> <span>Return Book</span>
        </a>
        <a href="fines.php" class="menu-item">
            <i class="fas fa-coins"></i> <span>Fines</span>
        </a>
        <a href="manage_categories.php" class="menu-item">
            <i class="fas fa-list"></i> <span>Categories</span>
        </a>
        <a href="reports.php" class="menu-item">
            <i class="fas fa-chart-line"></i> <span>Reports</span>
        </a>
         <a href="profile.php" class="menu-item">
            <i class="fas fa-user-cog"></i> <span>My Profile</span>
        </a>
        
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="../auth/logout.php" class="menu-item" style="color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
        </div>
    </div>
</div>
</file>

<file path="admin/add_book.php">
<?php
require_once '../config/db.php';
requireAdmin();

// Fetch Categories for Dropdown
$cat_query = mysqli_query($conn, "SELECT name FROM categories ORDER BY name ASC");

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    verify_csrf();

    $title    = $_POST['title'];
    $author   = $_POST['author'];
    $isbn     = $_POST['isbn'];
    $category = $_POST['category']; 
    $copies   = (int)$_POST['copies'];
    
    $cover = 'default.png';
    if(isset($_FILES['cover']) && $_FILES['cover']['error'] == 0) {
        $ext = pathinfo($_FILES['cover']['name'], PATHINFO_EXTENSION);
        $new_name = uniqid() . "." . $ext;
        
        // Use an absolute path to save the file
        $target_dir = $_SERVER['DOCUMENT_ROOT'] . "/library management system/assets/uploads/";
        
        if(move_uploaded_file($_FILES['cover']['tmp_name'], $target_dir . $new_name)) {
            $cover = $new_name;
        }
    }

    mysqli_begin_transaction($conn);
    try {
        $check = mysqli_query($conn, "SELECT id FROM books WHERE isbn = '$isbn'");
        if(mysqli_num_rows($check) > 0) throw new Exception("ISBN exists.");

        $sql = "INSERT INTO books (title, author, isbn, category, total_copies, available_copies, cover_image) VALUES (?, ?, ?, ?, ?, ?, ?)";
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, "ssssiis", $title, $author, $isbn, $category, $copies, $copies, $cover);
        mysqli_stmt_execute($stmt);
        $book_id = mysqli_insert_id($conn);
        
        $sql_copy = "INSERT INTO book_copies (book_id, unique_code, status) VALUES (?, ?, 'available')";
        $stmt_copy = mysqli_prepare($conn, $sql_copy);
        
        for ($i = 1; $i <= $copies; $i++) {
            $code = $isbn . "-" . rand(100,999) . "-" . $i;
            mysqli_stmt_bind_param($stmt_copy, "is", $book_id, $code);
            mysqli_stmt_execute($stmt_copy);
        }
        
        mysqli_commit($conn);
        setAlert('success', 'Success', 'Book added successfully!');
        header("Location: manage_book.php");
        exit;
    } catch (Exception $e) {
        mysqli_rollback($conn);
        setAlert('error', 'Error', $e->getMessage());
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Add Book</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .category-group { display: flex; gap: 10px; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 300px; }
    </style>
</head>
<body>
    <div class="admin-container">
        <?php include '../includes/admin_sidebar.php'; ?>
        <div class="main-content">
            <div class="content-header"><h1>Add Book</h1></div>
            <div class="card">
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                    <div class="form-group"><label>Title</label><input type="text" name="title" class="form-control" required></div>
                    <div class="form-row" style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex:1"><label>Author</label><input type="text" name="author" class="form-control" required></div>
                        <div class="form-group" style="flex:1"><label>ISBN</label><input type="text" name="isbn" class="form-control" required></div>
                    </div>
                    <div class="form-row" style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex:1">
                            <label>Category</label>
                            <div class="category-group">
                                <select name="category" id="category_dropdown" class="form-control" required>
                                    <option value="">Select Category</option>
                                    <?php while($c = mysqli_fetch_assoc($cat_query)): ?>
                                        <option value="<?= htmlspecialchars($c['name']) ?>"><?= htmlspecialchars($c['name']) ?></option>
                                    <?php endwhile; ?>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="openModal()">+</button>
                            </div>
                        </div>
                        <div class="form-group" style="flex:1"><label>Copies</label><input type="number" name="copies" class="form-control" value="1" min="1" required></div>
                    </div>
                    <div class="form-group"><label>Cover Image</label><input type="file" name="cover" class="form-control" accept="image/*"></div>
                    <button class="btn btn-primary">Add Book</button>
                </form>
            </div>
        </div>
    </div>

    <div id="catModal" class="modal">
        <div class="modal-content">
            <h3>Add Category</h3>
            <input type="text" id="new_cat_name" class="form-control" placeholder="Name" style="margin: 15px 0;">
            <div style="display:flex; gap:10px;">
                <button type="button" class="btn btn-primary" onclick="submitCategory()">Add</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <?php include '../includes/footer.php'; ?>
    <script>
        function openModal() { document.getElementById('catModal').style.display = 'block'; }
        function closeModal() { document.getElementById('catModal').style.display = 'none'; }
        function submitCategory() {
            const name = document.getElementById('new_cat_name').value;
            if(!name) return;
            const fd = new FormData(); fd.append('name', name);
            fetch('ajax_add_category.php', { method: 'POST', body: fd })
            .then(res => res.json()).then(data => {
                if(data.status === 'success'){
                    const opt = new Option(data.name, data.name);
                    const sel = document.getElementById('category_dropdown');
                    sel.add(opt); sel.value = data.name;
                    closeModal();
                } else { alert(data.message); }
            });
        }
    </script>
</body>
</html>
</file>

</files>
